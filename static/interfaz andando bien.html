<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOTOSHOW | Dashboard</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
    
    /* Añade estos estilos a tu CSS existente */
.webcam-popup-content {
    position: relative;
    width: 100%;
    aspect-ratio: 3/4; /* Formato selfie rectangular vertical */
    background: #000;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
}

.webcam-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    /* Corrección del efecto espejo para cámara frontal */
    transform: scaleX(-1);
    /* Asegurarse de que el video esté por encima del placeholder */
    position: relative;
    z-index: 1;
}

.webcam-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    background: #000;
    z-index: 0;
}
        /* Variables CSS para mejor mantenimiento */
        :root {
            --primary-dark: #1a0a2e;
            --secondary-dark: #2d1b4e;
            --primary-blue: #2563eb;
            --primary-light-blue: #3b82f6;
            --primary-purple: #8b5cf6;
            --text-light: #d1d5db;
            --text-muted: #9ca3af;
            --white: #ffffff;
            --bg-light: #f9fafb;
            --bg-card: #ffffff;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Reset y estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--bg-light);
            color: #111827;
            overflow-x: hidden;
            line-height: 1.6;
        }

        html {
            scroll-behavior: smooth;
        }

        /* Dashboard Layout */
        .dashboard {
            min-height: 100vh;
            display: flex;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 16rem;
            background: rgba(26, 10, 46, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-lg);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 50;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-open {
            transform: translateX(0);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 4rem;
            padding: 0 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            text-decoration: none;
        }

        .logo-icon {
            width: 2.5rem;
            height: 2.5rem;
            background: linear-gradient(135deg, var(--primary-light-blue) 0%, var(--primary-purple) 100%);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .logo:hover .logo-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--white);
            text-decoration: none;
        }

        .close-sidebar {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: var(--text-light);
            border-radius: 0.375rem;
            transition: all 0.2s;
        }

        .close-sidebar:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .sidebar-nav {
            flex: 1;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            color: var(--text-light);
            font-weight: 500;
            width: 100%;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .nav-item-active {
            background: linear-gradient(135deg, var(--primary-light-blue) 0%, var(--primary-purple) 100%);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .nav-icon {
            font-size: 1.25rem;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-text {
            font-size: 0.875rem;
        }

        .sidebar-stats {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(26, 10, 46, 0.5);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--white);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-left: 0;
            width: 100%;
            transition: margin-left 0.3s ease;
            position: relative;
        }

        /* Añadido para manejar mejor el estado de la barra lateral */
        .sidebar-open ~ .main-content {
            margin-left: 0;
        }

        .header {
            background: rgba(26, 10, 46, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .menu-button {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: var(--text-light);
            border-radius: 0.375rem;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .menu-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--white);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0;
        }

        .page-icon {
            font-size: 1.25rem;
        }

        .page-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin: 0.25rem 0 0 0;
        }

        .header-right {
            display: none;
        }

        .last-update {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .connection-status {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: var(--bg-light);
        }

        /* Dashboard Content */
        .dashboard-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .metric-card {
            background: var(--bg-card);
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .metric-info {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary-light-blue) 0%, var(--primary-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-icon {
            font-size: 2rem;
            opacity: 0.7;
            color: var(--primary-light-blue);
        }

        .activity-card {
            background: var(--bg-card);
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .activity-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            padding: 1.5rem 1.5rem 0 1.5rem;
            margin-bottom: 1rem;
        }

        .activity-list {
            padding: 0 1.5rem 1.5rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--bg-light);
            border-radius: 0.5rem;
            transition: transform 0.2s ease;
        }

        .activity-item:hover {
            transform: translateX(5px);
        }

        .activity-icon {
            font-size: 1.25rem;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-card);
            border-radius: 0.375rem;
        }

        .activity-info {
            flex: 1;
        }

        .activity-action {
            font-size: 0.875rem;
            font-weight: 500;
            color: #111827;
        }

        .activity-details {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .activity-time {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Upload Content */
        .upload-content {
            max-width: 40rem;
            margin: 0 auto;
        }

        .upload-card {
            background: var(--bg-card);
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            padding: 2rem;
            border: 1px solid var(--border-color);
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 0.5rem;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: var(--primary-light-blue);
            background-color: rgba(59, 130, 246, 0.05);
        }

        .drag-active {
            border-color: var(--primary-light-blue);
            background-color: rgba(59, 130, 246, 0.1);
        }

        .uploading {
            border-color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }

        .upload-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .spinner {
            font-size: 3rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .upload-prompt {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--text-muted);
        }

        .upload-title {
            font-size: 1.125rem;
            font-weight: 500;
            color: #111827;
        }

        .upload-subtitle {
            color: var(--text-muted);
        }

        .upload-formats {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .upload-button {
            background: linear-gradient(135deg, var(--primary-light-blue) 0%, var(--primary-purple) 100%);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .upload-text {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--primary-light-blue);
        }

        .upload-info {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Files List */
        .files-list {
            margin-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1.5rem;
        }

        .files-list-title {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .files-count {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: normal;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: var(--bg-light);
            margin-bottom: 0.5rem;
            transition: background-color 0.2s;
        }

        .file-item:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }

        .file-icon {
            font-size: 1.5rem;
            margin-right: 0.75rem;
            color: var(--text-muted);
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: #111827;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .file-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .file-status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .file-status-uploading {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .file-status-success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .file-status-error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .file-status-orientation {
            background-color: #e0e7ff;
            color: #3730a3;
        }

        .file-progress {
            height: 4px;
            background-color: var(--border-color);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .file-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light-blue), var(--primary-purple));
            width: 0%;
            transition: width 0.3s;
        }

        .upload-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .btn-clear {
            background-color: var(--bg-light);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        .btn-clear:hover {
            background-color: var(--border-color);
            color: #374151;
        }

        /* Orientation Correction */
        .orientation-correction {
            margin-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1.5rem;
        }

        .orientation-title {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .orientation-icon {
            font-size: 1.2rem;
            color: var(--primary-purple);
        }

        .orientation-preview {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .orientation-image-container {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .orientation-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .orientation-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background-color: var(--bg-light);
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .orientation-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--white);
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .orientation-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .orientation-info {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            padding: 0.75rem;
            background-color: rgba(59, 130, 246, 0.1);
            border-radius: 0.5rem;
            border-left: 3px solid var(--primary-light-blue);
        }

        /* Search Content */
        .search-content {
            max-width: 32rem;
            margin: 0 auto;
        }

        .search-card {
            background: var(--bg-card);
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            padding: 2rem;
            border: 1px solid var(--border-color);
        }

        .search-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1.5rem;
        }

        .search-info {
            background-color: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            color: #0369a1;
        }

        .threshold-control {
            margin-bottom: 2rem;
        }

        .threshold-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .threshold-slider {
            width: 100%;
            height: 0.5rem;
            background-color: var(--border-color);
            border-radius: 0.25rem;
            outline: none;
            cursor: pointer;
        }

        .threshold-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .search-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .webcam-section {
            display: none; /* Ocultamos la sección original de la cámara */
        }

        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .file-upload-area:hover {
            border-color: var(--primary-light-blue);
            background-color: rgba(59, 130, 246, 0.05);
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .file-upload-icon {
            font-size: 2rem;
            color: var(--text-muted);
        }

        .file-upload-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: #111827;
        }

        .file-upload-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .hidden-input {
            display: none;
        }

        /* Gallery Content */
        .gallery-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .gallery-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .gallery-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .gallery-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .gallery-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin: 0;
        }

        /* Search Mode Indicator */
        .search-mode-indicator {
            margin-bottom: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .search-mode-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-light-blue), var(--primary-purple), var(--primary-light-blue));
            background-size: 200% 100%;
            animation: searchIndicatorGlow 2s linear infinite;
        }

        .search-indicator-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .search-indicator-icon {
            font-size: 20px;
            margin-right: 5px;
        }

        .search-indicator-text {
            flex: 1;
            min-width: 250px;
            color: #1565c0;
            font-weight: 500;
            font-size: 14px;
        }

        @keyframes searchIndicatorGlow {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        @media (min-width: 1200px) {
            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        @media (min-width: 1400px) {
            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        .photo-card {
            background: var(--bg-card);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .photo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .photo-card-match {
            border: 2px solid #4caf50;
            background: linear-gradient(135deg, #ffffff 0%, #f1f8e9 100%);
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.25);
            position: relative;
        }

        .photo-card-match::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #4caf50, #8bc34a, #4caf50);
            border-radius: inherit;
            z-index: -1;
            opacity: 0.3;
        }

        .photo-image {
            aspect-ratio: 1;
            position: relative;
            overflow: hidden;
        }

        .photo-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-placeholder {
            width: 100%;
            height: 100%;
            background-color: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--text-muted);
        }

        .photo-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(0, 0, 0, 0.75);
            color: var(--white);
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .match-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: var(--white);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2;
        }

        .photo-info {
            padding: 1rem;
        }

        .photo-title {
            font-weight: 500;
            color: #111827;
            margin: 0 0 0.25rem 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .photo-date {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin: 0 0 0.75rem 0;
        }

        .match-info {
            color: #2e7d32;
            font-size: 12px;
            font-weight: 500;
            margin: 4px 0;
            padding: 2px 6px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 4px;
            display: inline-block;
        }

        .photo-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .photo-actions .btn {
            flex: 1;
            min-width: 80px;
        }

        /* Results Content */
        .results-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .results-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .results-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin: 0;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        @media (min-width: 1200px) {
            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        @media (min-width: 1400px) {
            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        .result-card {
            background: var(--bg-card);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .result-image {
            aspect-ratio: 1;
            position: relative;
            overflow: hidden;
        }

        .result-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .result-placeholder {
            width: 100%;
            height: 100%;
            background-color: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--text-muted);
        }

        .result-rank {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: linear-gradient(135deg, var(--primary-light-blue) 0%, var(--primary-purple) 100%);
            color: var(--white);
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }

        .result-similarity {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #10b981;
            color: var(--white);
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }

        .result-info {
            padding: 1rem;
        }

        .result-title {
            font-weight: 500;
            color: #111827;
            margin: 0 0 0.25rem 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .result-score {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin: 0 0 0.25rem 0;
        }

        .result-id {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin: 0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--text-muted);
        }

        .empty-title {
            font-size: 1.125rem;
            font-weight: 500;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        .empty-subtitle {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        .empty-actions {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.875rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-light-blue) 0%, var(--primary-purple) 100%);
            color: var(--white);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background-color: #10b981;
            color: var(--white);
        }

        .btn-success:hover:not(:disabled) {
            background-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background-color: #ef4444;
            color: var(--white);
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn-ghost {
            background-color: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        .btn-ghost:hover {
            background-color: var(--bg-light);
            color: #111827;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary-light-blue);
            color: var(--primary-light-blue);
        }

        .btn-outline:hover {
            background: var(--primary-light-blue);
            color: var(--white);
        }

        .btn-full {
            width: 100%;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn-icon {
            padding: 8px 12px;
            min-width: auto;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Photo Popup */
        .photo-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        .photo-popup {
            background: var(--bg-card);
            border-radius: 1rem;
            max-width: 90vw;
            max-height: 90vh;
            width: 800px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .photo-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-light);
        }

        .photo-popup-title h3 {
            margin: 0 0 4px 0;
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }

        .photo-popup-date {
            margin: 0;
            font-size: 14px;
            color: var(--text-muted);
        }

        .photo-popup-actions {
            display: flex;
            gap: 8px;
        }

        .photo-popup-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .photo-popup-image {
            flex: 1;
            position: relative;
            background: var(--bg-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .photo-popup-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .photo-popup-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
        }

        .placeholder-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .placeholder-text {
            font-size: 16px;
            font-weight: 500;
        }

        .photo-popup-info {
            width: 280px;
            background: var(--bg-light);
            padding: 24px;
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .photo-info-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .info-value {
            font-size: 14px;
            font-weight: 500;
            color: #111827;
        }

        .photo-popup-description {
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .photo-popup-description p {
            margin: 0;
            font-size: 14px;
            line-height: 1.6;
            color: #4a5568;
        }

        /* URL Container */
        .url-container {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .url-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .url-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .url-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            color: #111827;
            background-color: var(--bg-light);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .url-actions {
            display: flex;
            gap: 8px;
        }

        .copy-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981;
            color: var(--white);
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .copy-notification.show {
            opacity: 1;
        }

        /* Webcam Popup - NUEVO */
        .webcam-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        .webcam-popup {
            background: var(--bg-card);
            border-radius: 1rem;
            width: 100%;
            max-width: 400px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .webcam-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-light);
        }

        .webcam-popup-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .webcam-popup-content {
            position: relative;
            width: 100%;
            aspect-ratio: 3/4; /* Formato selfie rectangular vertical */
            background: #000;
            overflow: hidden;
        }

        .webcam-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Corrección del efecto espejo para cámara frontal */
            transform: scaleX(-1);
        }

        .webcam-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            background: #000;
        }

        .webcam-placeholder-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .webcam-placeholder-text {
            font-size: 16px;
            text-align: center;
            max-width: 80%;
        }

        .webcam-popup-footer {
            padding: 16px 20px;
            background: var(--bg-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .webcam-status {
            font-size: 14px;
            color: var(--text-muted);
        }

        .webcam-actions {
            display: flex;
            gap: 12px;
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }

        /* Clients Grid */
        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .client-card {
            background: var(--bg-card);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .client-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .client-header {
            padding: 1rem;
            background: var(--bg-light);
            border-bottom: 1px solid var(--border-color);
        }

        .client-phone {
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .client-date {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .client-content {
            padding: 1rem;
            display: flex;
            gap: 1rem;
        }

        .client-image {
            width: 80px;
            height: 80px;
            border-radius: 0.5rem;
            overflow: hidden;
            flex-shrink: 0;
        }

        .client-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .client-image-placeholder {
            width: 100%;
            height: 100%;
            background-color: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--text-muted);
        }

        .client-info {
            flex: 1;
        }

        .client-match {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .client-match-info {
            font-weight: 500;
            color: #111827;
        }

        .client-similarity {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .client-similarity-value {
            font-weight: 600;
            color: #10b981;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .metric-card,
        .activity-card,
        .upload-card,
        .search-card,
        .photo-card,
        .result-card {
            animation: fadeIn 0.3s ease-out;
        }

        /* Scrollbar */
        .content::-webkit-scrollbar {
            width: 6px;
        }

        .content::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        .content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .content::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Responsive Design */
        @media (min-width: 1024px) {
            .sidebar {
                position: static;
                transform: none;
                width: 14rem;
                flex-shrink: 0;
            }

            .main-content {
                margin-left: 0;
                width: auto;
                flex: 1;
            }

            .menu-button {
                display: none;
            }

            .close-sidebar {
                display: none;
            }

            .header-right {
                display: block;
            }

            .sidebar-overlay {
                display: none;
            }
        }

        @media (max-width: 1023px) {
            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
            }
        }

        @media (min-width: 768px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .gallery-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-indicator-content {
                flex-direction: column;
                align-items: flex-start;
                text-align: center;
            }
            
            .search-indicator-text {
                min-width: auto;
            }
            
            .empty-actions {
                flex-direction: column;
            }
            
            .photo-card-match {
                transform: none;
            }

            .photo-popup {
                width: 95vw;
                height: 90vh;
                max-height: none;
            }
            
            .photo-popup-content {
                flex-direction: column;
            }
            
            .photo-popup-image {
                min-height: 250px;
                flex: 0 0 auto;
            }
            
            .photo-popup-info {
                width: 100%;
                max-height: 200px;
                border-left: none;
                border-top: 1px solid var(--border-color);
            }

            .webcam-popup {
                max-width: 90vw;
            }
        }

        @media (min-width: 640px) {
            .content {
                padding: 1.5rem;
            }

            .upload-content,
            .search-content {
                max-width: 36rem;
            }
        }

        /* Hidden elements */
        .hidden {
            display: none;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">🔍</div>
                    <span class="logo-text">FOTOSHOW</span>
                </div>
                <button class="close-sidebar" onclick="closeSidebar()">✕</button>
            </div>

            <nav class="sidebar-nav">
                <button class="nav-item nav-item-active" data-tab="dashboard" onclick="switchTab('dashboard')">
                    <span class="nav-icon">📊</span>
                    <span class="nav-text">Panel Principal</span>
                </button>
                <button class="nav-item" data-tab="upload" onclick="switchTab('upload')">
                    <span class="nav-icon">📤</span>
                    <span class="nav-text">Subir Fotos</span>
                </button>
                <button class="nav-item" data-tab="search" onclick="switchTab('search')">
                    <span class="nav-icon">🔍</span>
                    <span class="nav-text">Buscar Cara</span>
                </button>
                <button class="nav-item" data-tab="gallery" onclick="switchTab('gallery')">
                    <span class="nav-icon">🖼️</span>
                    <span class="nav-text">Galería</span>
                </button>
                <button class="nav-item" data-tab="results" onclick="switchTab('results')">
                    <span class="nav-icon">🎯</span>
                    <span class="nav-text">Resultados</span>
                </button>
                <button class="nav-item" data-tab="clients" onclick="switchTab('clients')">
                    <span class="nav-icon">👥</span>
                    <span class="nav-text">Clientes Buscados</span>
                </button>
            </nav>

            <div class="sidebar-stats">
                <div class="stat-item">
                    <div class="stat-number" id="total-photos">0</div>
                    <div class="stat-label">Fotos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-faces">0</div>
                    <div class="stat-label">Caras</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="menu-button" onclick="openSidebar()">☰</button>
                    
                    <div class="header-info">
                        <h1 class="page-title">
                            <span class="page-icon" id="page-icon">📊</span>
                            <span id="page-title-text">Panel Principal</span>
                        </h1>
                        <p class="page-subtitle" id="page-subtitle">Resumen general de tu colección</p>
                    </div>
                </div>

                <div class="header-right">
                    <span class="last-update">
                        Última actualización: <span id="last-update-time"></span>
                    </span>
                    <div class="connection-status">
                        Backend: <span id="backend-url"></span>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <main class="content">
                <!-- Dashboard Tab -->
                <div id="dashboard-tab" class="tab-content active">
                    <div class="dashboard-content">
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-info">
                                    <div class="metric-label">Total Fotos</div>
                                    <div class="metric-value" id="dashboard-total-photos">0</div>
                                </div>
                                <div class="metric-icon">🖼️</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-info">
                                    <div class="metric-label">Caras Detectadas</div>
                                    <div class="metric-value" id="dashboard-total-faces">0</div>
                                </div>
                                <div class="metric-icon">👥</div>
                            </div>

                            <div class="metric-card">
                                <div class="metric-info">
                                    <div class="metric-label">Búsquedas</div>
                                    <div class="metric-value" id="dashboard-searches">0</div>
                                </div>
                                <div class="metric-icon">🔍</div>
                            </div>

                            <div class="metric-card">
                                <div class="metric-info">
                                    <div class="metric-label">Clientes</div>
                                    <div class="metric-value" id="dashboard-clients">0</div>
                                </div>
                                <div class="metric-icon">👥</div>
                            </div>
                        </div>

                        <div class="activity-card">
                            <h3 class="activity-title">Actividad Reciente</h3>
                            <div class="activity-list">
                                <div class="activity-item">
                                    <div class="activity-icon">📤</div>
                                    <div class="activity-info">
                                        <div class="activity-action">Foto subida</div>
                                        <div class="activity-details">family_reunion.jpg - 6 caras detectadas</div>
                                    </div>
                                    <div class="activity-time">Hace 2 min</div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">🔍</div>
                                    <div class="activity-info">
                                        <div class="activity-action">Búsqueda realizada</div>
                                        <div class="activity-details">selfie_search.jpg - 3 caras detectadas</div>
                                    </div>
                                    <div class="activity-time">Hace 15 min</div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">📤</div>
                                    <div class="activity-info">
                                        <div class="activity-action">Foto subida</div>
                                        <div class="activity-details">birthday_party.jpg - 8 caras detectadas</div>
                                    </div>
                                    <div class="activity-time">Hace 1 hora</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Tab -->
                <div id="upload-tab" class="tab-content">
                    <div class="upload-content">
                        <div class="upload-card">
                            <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                                <input type="file" id="file-input" class="hidden-input" accept="image/*" multiple onchange="handleFileUpload(event)">
                                
                                <div class="upload-prompt" id="upload-prompt">
                                    <div class="upload-icon">📷</div>
                                    <div class="upload-title">Sube tus fotos</div>
                                    <div class="upload-subtitle">Arrastra archivos aquí o haz clic para seleccionar</div>
                                    <div class="upload-formats">JPG • PNG • GIF • WebP</div>
                                    <button class="upload-button">Seleccionar Archivos</button>
                                </div>

                                <div class="upload-status hidden" id="upload-status">
                                    <div class="spinner">⏳</div>
                                    <div class="upload-text">Procesando imágenes...</div>
                                    <div class="upload-subtitle">Detectando caras automáticamente</div>
                                </div>
                            </div>
                            
                            <!-- Lista de archivos seleccionados -->
                            <div class="files-list hidden" id="files-list">
                                <div class="files-list-title">
                                    Archivos seleccionados
                                    <span class="files-count" id="files-count">0 archivos</span>
                                </div>
                                <div id="files-container"></div>
                                
                                <div class="upload-actions">
                                    <button class="btn btn-primary" onclick="uploadAllFiles()">
                                        Subir Todos los Archivos
                                    </button>
                                    <button class="btn btn-clear" onclick="clearFileList()">
                                        Limpiar Lista
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Sección de corrección de orientación -->
                            <div class="orientation-correction hidden" id="orientation-correction">
                                <div class="orientation-title">
                                    <span class="orientation-icon">🔄</span>
                                    Corrección de Orientación
                                </div>
                                <div class="orientation-info">
                                    Hemos detectado que algunas fotos pueden estar en una orientación incorrecta. Puedes corregirlas automáticamente antes de subirlas.
                                </div>
                                <div class="orientation-preview" id="orientation-preview">
                                    <!-- Las imágenes se agregarán dinámicamente -->
                                </div>
                                <div class="orientation-actions">
                                    <button class="btn btn-primary" onclick="applyOrientationCorrection()">
                                        Aplicar Corrección
                                    </button>
                                    <button class="btn btn-ghost" onclick="skipOrientationCorrection()">
                                        Omitir Corrección
                                    </button>
                                </div>
                            </div>
                            
                            <div class="upload-info">
                                Las caras se detectan automáticamente y se indexan para búsquedas futuras
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Tab -->
                <div id="search-tab" class="tab-content">
                    <div class="search-content">
                        <div class="search-card">
                            <h3 class="search-title">Configuración de Búsqueda</h3>
                            
                            <div class="search-info">
                                <strong>Importante:</strong> Las fotos que uses para buscar no se guardarán en tu galería. Solo se usarán para encontrar coincidencias en tus fotos existentes.
                            </div>
                            
                            <div class="threshold-control">
                                <label class="threshold-label" for="threshold-slider">
                                    Umbral de Similitud: <span id="threshold-display">70%</span>
                                </label>
                                <input type="range" id="threshold-slider" min="50" max="95" step="5" value="70" class="threshold-slider" oninput="updateThreshold(this.value)">
                                <div class="threshold-labels">
                                    <span>Más coincidencias</span>
                                    <span>Mayor precisión</span>
                                </div>
                            </div>

                            <div class="search-options">
                                <button class="btn btn-success btn-full" onclick="openWebcamPopup()" id="webcam-btn">
                                    📷 Usar Cámara Web
                                </button>

                                <!-- Sección original de cámara oculta -->
                                <div class="webcam-section hidden" id="webcam-section">
                                    <div class="webcam-container">
                                        <video id="webcam" class="webcam" autoplay playsinline></video>
                                        <div class="webcam-placeholder" id="webcam-placeholder">📷</div>
                                    </div>
                                    <button class="btn btn-primary btn-full" onclick="capturePhoto()" id="capture-btn">
                                        Capturar y Buscar
                                    </button>
                                </div>

                                <div class="divider">o</div>

                                <div class="file-upload-area">
                                    <input type="file" id="search-file-input" class="hidden-input" accept="image/*" onchange="searchWithFile(event)">
                                    <label for="search-file-input" class="file-upload-label">
                                        <div class="file-upload-icon">🖼️</div>
                                        <div class="file-upload-text">Subir Selfie</div>
                                        <div class="file-upload-subtitle">Para buscar en tu colección</div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gallery Tab -->
                <div id="gallery-tab" class="tab-content">
                    <div class="gallery-content">
                        <div class="gallery-header">
                            <div class="gallery-info">
                                <h3 class="gallery-title" id="gallery-title">Galería de Fotos</h3>
                                <p class="gallery-subtitle" id="gallery-subtitle">0 fotos en total</p>
                            </div>
                            <div class="gallery-actions">
                                <button class="btn btn-ghost hidden" id="clear-search-btn" onclick="clearSearchFilter()">
                                    🔄 Ver Todas las Fotos
                                </button>
                                <button class="btn btn-primary" onclick="switchTab('upload')">
                                    ➕ Añadir Fotos
                                </button>
                            </div>
                        </div>

                        <div class="search-mode-indicator hidden" id="search-mode-indicator">
                            <div class="search-indicator-content">
                                <span class="search-indicator-icon">🎯</span>
                                <span class="search-indicator-text">
                                    Mostrando solo fotos que contienen coincidencias de tu búsqueda
                                </span>
                                <button class="btn btn-small btn-outline" onclick="switchTab('results')">
                                    Ver Detalles
                                </button>
                            </div>
                        </div>

                        <div id="photos-container">
                            <div class="empty-state">
                                <div class="empty-icon">🖼️</div>
                                <h3 class="empty-title">No hay fotos aún</h3>
                                <p class="empty-subtitle">¡Sube algunas fotos para comenzar!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Tab -->
                <div id="results-tab" class="tab-content">
                    <div class="results-content">
                        <div id="results-container">
                            <div class="empty-state">
                                <div class="empty-icon">🎯</div>
                                <h3 class="empty-title">No hay resultados aún</h3>
                                <p class="empty-subtitle">Usa la función de búsqueda para encontrar coincidencias</p>
                                <button class="btn btn-primary" onclick="switchTab('search')">
                                    Comenzar Búsqueda
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clients Tab -->
                <div id="clients-tab" class="tab-content">
                    <div class="gallery-content">
                        <div class="gallery-header">
                            <div class="gallery-info">
                                <h3 class="gallery-title">Clientes que buscaron sus fotos</h3>
                                <p class="gallery-subtitle" id="clients-subtitle">0 clientes en total</p>
                            </div>
                            <div class="gallery-actions">
                                <button class="btn btn-ghost" onclick="refreshClients()">
                                    🔄 Actualizar Lista
                                </button>
                            </div>
                        </div>

                        <div id="clients-container">
                            <div class="empty-state">
                                <div class="empty-icon">👥</div>
                                <h3 class="empty-title">No hay clientes aún</h3>
                                <p class="empty-subtitle">Los clientes que busquen sus fotos aparecerán aquí</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
    </div>

    <!-- Photo Popup -->
    <div class="photo-popup-overlay hidden" id="photo-popup-overlay" onclick="closePhotoPopup()">
        <div class="photo-popup" onclick="event.stopPropagation()">
            <div class="photo-popup-header">
                <div class="photo-popup-title">
                    <h3 id="popup-filename">Nombre del archivo</h3>
                    <p class="photo-popup-date" id="popup-date">Fecha de subida</p>
                </div>
                <div class="photo-popup-actions">
                    <button class="btn btn-success btn-icon" onclick="printPhoto()" title="Imprimir en A5">
                        🖨️ Imprimir A5
                    </button>
                    <button class="btn btn-ghost btn-icon" onclick="closePhotoPopup()" title="Cerrar">
                        ✕
                    </button>
                </div>
            </div>
            
            <div class="photo-popup-content">
                <div class="photo-popup-image">
                    <img id="popup-image" src="" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="photo-popup-placeholder hidden" id="popup-placeholder">
                        
                    </div>
                </div>
                
                <div class="photo-popup-info">
                    <div class="photo-info-grid">
                        <div class="info-item">
                            <span class="info-label">Caras detectadas:</span>
                            <span class="info-value" id="popup-faces-count">0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tamaño del archivo:</span>
                            <span class="info-value" id="popup-file-size">N/A</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ID de la foto:</span>
                            <span class="info-value" id="popup-photo-id">N/A</span>
                        </div>
                    </div>
                    
                    <!-- Nueva sección para la URL de la imagen -->
                    <div class="url-container">
                        <div class="url-label">URL de la imagen:</div>
                        <div class="url-input-container">
                            <input type="text" class="url-input" id="popup-url" readonly>
                        </div>
                        <div class="url-actions">
                            <button class="btn btn-primary btn-small" onclick="copyPhotoUrl()">
                                📋 Copiar URL
                            </button>
                            <button class="btn btn-outline btn-small" onclick="openPhotoUrl()">
                                🔗 Abrir en nueva pestaña
                            </button>
                        </div>
                    </div>
                    
                    <div class="photo-popup-description">
                        <p id="popup-description">
                            Esta foto contiene caras detectadas. Puedes imprimir esta imagen en formato A5 optimizado para una mejor calidad de impresión.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Webcam Popup - NUEVO -->
    <div class="webcam-popup-overlay hidden" id="webcam-popup-overlay" onclick="closeWebcamPopup()">
        <div class="webcam-popup" onclick="event.stopPropagation()">
            <div class="webcam-popup-header">
                <h3 class="webcam-popup-title">Tomar Selfie para Búsqueda</h3>
                <button class="btn btn-ghost btn-icon" onclick="closeWebcamPopup()" title="Cerrar">
                    ✕
                </button>
            </div>
            
            <div class="webcam-popup-content">
                <video id="webcam-video" class="webcam-video" autoplay playsinline></video>
                <div class="webcam-placeholder" id="webcam-placeholder">
                    <div class="webcam-placeholder-icon">📷</div>
                    <div class="webcam-placeholder-text">Iniciando cámara...</div>
                </div>
            </div>
            
            <div class="webcam-popup-footer">
                <div class="webcam-status" id="webcam-status">Cámara lista</div>
                <div class="webcam-actions">
                    <button class="btn btn-ghost" onclick="closeWebcamPopup()">
                        Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="capturePhotoFromPopup()" id="capture-btn">
                        📷 Capturar y Buscar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificación de copia -->
    <div class="copy-notification" id="copy-notification">
        URL copiada al portapapeles
    </div>

    <script>
        // Global variables
        let currentTab = 'dashboard';
        let uploadedPhotos = [];
        let searchResults = [];
        let isUploading = false;
        let isSearching = false;
        let showWebcam = false;
        let searchThreshold = 0.7;
        let stats = { total_photos: 0, total_faces: 0 };
        let isSearchMode = false;
        let filteredPhotos = [];
        let selectedPhoto = null;
        let webcamStream = null;
        let searchedClients = [];
        
        // Variables para la carga múltiple de archivos
        let selectedFiles = [];
        let fileUploadQueue = [];
        let currentUploadIndex = 0;
        let totalUploadsCompleted = 0;
        let totalUploadsFailed = 0;
        
        // Variables para la corrección de orientación
        let filesNeedingCorrection = [];
        let correctedFiles = {};

        // Función para detectar si estamos accediendo localmente o por IP pública
        function getBackendURL() {
            const hostname = window.location.hostname;
            const port = window.location.port;
            const protocol = window.location.protocol;
            
            // Si estamos accediendo por localhost o 127.0.0.1, usar localhost
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:8888';
            }
            
            // Si estamos accediendo por la IP pública, usar la IP pública
            if (hostname === '191.97.117.104') {
                return 'http://191.97.117.104:8888';
            }
            
            // Para cualquier otro caso, usar la URL actual
            return `${protocol}//${hostname}${port ? ':' + port : ''}`;
        }

        const BACKEND_URL = getBackendURL();
        const API = `${BACKEND_URL}/api`;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Backend URL:', BACKEND_URL);
            console.log('API URL:', API);
            
            updateLastUpdateTime();
            document.getElementById('backend-url').textContent = BACKEND_URL;
            
            fetchPhotos();
            fetchStats();
            fetchSearchedClients();
            
            // Set up drag and drop for upload area
            setupDragAndDrop();
            
            // Update time every minute
            setInterval(updateLastUpdateTime, 60000);
        });

        // Navigation functions
        function openSidebar() {
            document.getElementById('sidebar').classList.add('sidebar-open');
            document.getElementById('sidebar-overlay').classList.remove('hidden');
            // Asegúrate de que el contenido principal no se desplace
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('sidebar-open');
            document.getElementById('sidebar-overlay').classList.add('hidden');
            // Restaura el scroll del cuerpo
            document.body.style.overflow = '';
        }

        function switchTab(tabName) {
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('nav-item-active');
                if (item.dataset.tab === tabName) {
                    item.classList.add('nav-item-active');
                }
            });

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');

            // Update page title and subtitle
            const pageInfo = {
                dashboard: { icon: '📊', title: 'Dashboard', subtitle: 'Resumen general de tu colección' },
                upload: { icon: '📤', title: 'Subir Fotos', subtitle: 'Sube nuevas fotos para detectar caras' },
                search: { icon: '🔍', title: 'Buscar Cara', subtitle: 'Busca caras en tu colección' },
                gallery: { icon: '🖼️', title: 'Galería', subtitle: 'Explora todas tus fotos subidas' },
                results: { icon: '🎯', title: 'Resultados', subtitle: 'Resultados de tu última búsqueda' },
                clients: { icon: '👥', title: 'Clientes Buscados', subtitle: 'Clientes que han buscado sus fotos' }
            };

            const info = pageInfo[tabName];
            document.getElementById('page-icon').textContent = info.icon;
            document.getElementById('page-title-text').textContent = info.title;
            document.getElementById('page-subtitle').textContent = info.subtitle;

            currentTab = tabName;
            closeSidebar();
        }

        // Utility functions
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update-time').textContent = now.toLocaleTimeString();
        }

        function updateThreshold(value) {
            searchThreshold = parseFloat(value) / 100;
            document.getElementById('threshold-display').textContent = value + '%';
        }

        // API functions
        async function fetchPhotos() {
            try {
                console.log('Fetching photos from:', `${API}/photos`);
                const response = await fetch(`${API}/photos`);
                const data = await response.json();
                console.log('Photos response:', data);
                if (data.success) {
                    uploadedPhotos = data.photos;
                    renderPhotos();
                }
            } catch (error) {
                console.error('Error fetching photos:', error);
            }
        }

        async function fetchStats() {
            try {
                console.log('Fetching stats from:', `${BACKEND_URL}/api-status`);
                const response = await fetch(`${BACKEND_URL}/api-status`);
                const data = await response.json();
                console.log('Stats response:', data);
                if (data.database) {
                    stats = data.database;
                    updateStatsDisplay();
                }
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        async function fetchSearchedClients() {
            try {
                console.log('Fetching searched clients from:', `${API}/searched-clients`);
                const response = await fetch(`${API}/searched-clients`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Searched clients response:', data);
                
                if (data.success) {
                    searchedClients = data.clients || [];
                    renderClients();
                    updateClientsStats();
                } else {
                    console.error('Error en la respuesta:', data.detail);
                    searchedClients = [];
                    renderClients();
                    updateClientsStats();
                }
            } catch (error) {
                console.error('Error fetching searched clients:', error);
                searchedClients = [];
                renderClients();
                updateClientsStats();
            }
        }

        function updateStatsDisplay() {
            document.getElementById('total-photos').textContent = stats.total_photos;
            document.getElementById('total-faces').textContent = stats.total_faces;
            document.getElementById('dashboard-total-photos').textContent = stats.total_photos;
            document.getElementById('dashboard-total-faces').textContent = stats.total_faces;
        }

        function updateClientsStats() {
            document.getElementById('dashboard-clients').textContent = searchedClients.length;
            document.getElementById('clients-subtitle').textContent = searchedClients.length + ' clientes en total';
        }

        // Upload functions
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-active');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-active');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-active');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    addFilesToQueue(files);
                }
            });
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                addFilesToQueue(files);
            }
        }

        function addFilesToQueue(files) {
            // Convert FileList to Array and add to selectedFiles
            const newFiles = Array.from(files);
            selectedFiles = [...selectedFiles, ...newFiles];
            
            // Show files list
            document.getElementById('files-list').classList.remove('hidden');
            
            // Update files count
            document.getElementById('files-count').textContent = `${selectedFiles.length} archivos`;
            
            // Render files list
            renderFilesList();
            
            // Procesar archivos para detectar orientación
            processFilesForOrientation();
        }

        function renderFilesList() {
            const container = document.getElementById('files-container');
            container.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.id = `file-item-${index}`;
                
                // Determine file status
                let statusClass = 'file-status-pending';
                let statusText = 'Pendiente';
                
                if (file.status === 'uploading') {
                    statusClass = 'file-status-uploading';
                    statusText = 'Subiendo...';
                } else if (file.status === 'success') {
                    statusClass = 'file-status-success';
                    statusText = 'Completado';
                } else if (file.status === 'error') {
                    statusClass = 'file-status-error';
                    statusText = 'Error';
                } else if (file.status === 'orientation') {
                    statusClass = 'file-status-orientation';
                    statusText = 'Revisando orientación';
                }
                
                // Format file size
                const fileSize = formatFileSize(file.size);
                
                fileItem.innerHTML = `
                    <div class="file-icon">📷</div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${fileSize}</div>
                        ${file.status === 'uploading' ? `
                            <div class="file-progress">
                                <div class="file-progress-bar" id="progress-${index}" style="width: ${file.progress || 0}%"></div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="file-status ${statusClass}">${statusText}</div>
                `;
                
                container.appendChild(fileItem);
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function clearFileList() {
            selectedFiles = [];
            filesNeedingCorrection = [];
            correctedFiles = {};
            document.getElementById('files-list').classList.add('hidden');
            document.getElementById('orientation-correction').classList.add('hidden');
            document.getElementById('file-input').value = '';
        }

        // Funciones para la corrección de orientación
        async function processFilesForOrientation() {
            filesNeedingCorrection = [];
            correctedFiles = {};
            
            // Ocultar sección de corrección mientras procesamos
            document.getElementById('orientation-correction').classList.add('hidden');
            
            // Procesar cada archivo para detectar si necesita corrección
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                file.status = 'orientation';
                renderFilesList();
                
                try {
                    const needsCorrection = await checkImageOrientation(file);
                    if (needsCorrection) {
                        filesNeedingCorrection.push({
                            file: file,
                            index: i,
                            corrected: false
                        });
                    }
                } catch (error) {
                    console.error('Error checking orientation for', file.name, error);
                }
                
                file.status = 'pending';
                renderFilesList();
            }
            
            // Si hay archivos que necesitan corrección, mostrar la sección
            if (filesNeedingCorrection.length > 0) {
                showOrientationCorrection();
            }
        }

        async function checkImageOrientation(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = function() {
                    // Crear un canvas para analizar la imagen
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // Obtener los datos de la imagen
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Análisis simple para detectar si la imagen podría estar rotada
                    // Buscamos patrones que sugieran que las caras están en una orientación no natural
                    
                    // Método 1: Verificar la relación de aspecto
                    const aspectRatio = canvas.width / canvas.height;
                    
                    // Si la imagen es muy ancha en comparación con su altura, podría estar rotada
                    if (aspectRatio > 1.5) {
                        // Podría ser una imagen horizontal, pero si detectamos caras, verificamos su orientación
                        // Este es un método simple, en un caso real usaríamos un modelo de ML más sofisticado
                        resolve(true);
                        return;
                    }
                    
                    // Método 2: Análisis de gradientes para detectar posibles caras en orientación incorrecta
                    // Este es un método simplificado, en producción usaríamos una librería de detección de caras
                    
                    // Por ahora, usaremos un enfoque basado en la detección de caras del backend
                    // Simulamos que algunas imágenes necesitan corrección para demostrar la funcionalidad
                    const randomCheck = Math.random();
                    if (randomCheck < 0.3) { // 30% de probabilidad de necesitar corrección para demostración
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                };
                
                img.onerror = function() {
                    reject(new Error('Error loading image'));
                };
                
                // Cargar la imagen
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function showOrientationCorrection() {
            const orientationSection = document.getElementById('orientation-correction');
            const previewContainer = document.getElementById('orientation-preview');
            
            // Limpiar el contenedor de vista previa
            previewContainer.innerHTML = '';
            
            // Mostrar vista previa de las imágenes que necesitan corrección
            filesNeedingCorrection.forEach((item, index) => {
                const file = item.file;
                const fileIndex = item.index;
                
                // Crear contenedor para la vista previa
                const imageContainer = document.createElement('div');
                imageContainer.className = 'orientation-image-container';
                
                // Crear etiqueta
                const label = document.createElement('div');
                label.className = 'orientation-label';
                label.textContent = file.name;
                imageContainer.appendChild(label);
                
                // Crear imagen original
                const originalContainer = document.createElement('div');
                originalContainer.className = 'orientation-image-container';
                
                const originalLabel = document.createElement('div');
                originalLabel.className = 'orientation-label';
                originalLabel.textContent = 'Original';
                originalContainer.appendChild(originalLabel);
                
                const originalImg = document.createElement('img');
                originalImg.className = 'orientation-image';
                originalImg.id = `original-${index}`;
                
                const originalBadge = document.createElement('div');
                originalBadge.className = 'orientation-badge';
                originalBadge.textContent = 'Posible rotación';
                
                originalContainer.appendChild(originalImg);
                originalContainer.appendChild(originalBadge);
                
                // Crear imagen corregida
                const correctedContainer = document.createElement('div');
                correctedContainer.className = 'orientation-image-container';
                
                const correctedLabel = document.createElement('div');
                correctedLabel.className = 'orientation-label';
                correctedLabel.textContent = 'Corregida';
                correctedContainer.appendChild(correctedLabel);
                
                const correctedImg = document.createElement('img');
                correctedImg.className = 'orientation-image';
                correctedImg.id = `corrected-${index}`;
                
                const correctedBadge = document.createElement('div');
                correctedBadge.className = 'orientation-badge';
                correctedBadge.textContent = 'Orientación corregida';
                correctedBadge.style.backgroundColor = '#10b981';
                
                correctedContainer.appendChild(correctedImg);
                correctedContainer.appendChild(correctedBadge);
                
                // Añadir contenedores al contenedor principal
                imageContainer.appendChild(originalContainer);
                imageContainer.appendChild(correctedContainer);
                previewContainer.appendChild(imageContainer);
                
                // Cargar imágenes
                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImg.src = e.target.result;
                    
                    // Crear una versión rotada de la imagen para la vista previa
                    const rotatedCanvas = document.createElement('canvas');
                    const rotatedCtx = rotatedCanvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = function() {
                        // Determinar la rotación necesaria (90 grados en sentido horario para este ejemplo)
                        const angle = 90 * Math.PI / 180;
                        
                        // Calcular nuevas dimensiones después de la rotación
                        const sin = Math.abs(Math.sin(angle));
                        const cos = Math.abs(Math.cos(angle));
                        
                        rotatedCanvas.width = img.height * sin + img.width * cos;
                        rotatedCanvas.height = img.height * cos + img.width * sin;
                        
                        // Aplicar rotación
                        rotatedCtx.translate(rotatedCanvas.width / 2, rotatedCanvas.height / 2);
                        rotatedCtx.rotate(angle);
                        rotatedCtx.drawImage(img, -img.width / 2, -img.height / 2);
                        
                        // Convertir el canvas a URL de datos
                        correctedImg.src = rotatedCanvas.toDataURL('image/jpeg', 0.9);
                        
                        // Guardar la imagen corregida para uso posterior
                        rotatedCanvas.toBlob(function(blob) {
                            correctedFiles[fileIndex] = blob;
                        }, 'image/jpeg', 0.9);
                    };
                    
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
            
            // Mostrar la sección de corrección
            orientationSection.classList.remove('hidden');
        }

        function applyOrientationCorrection() {
            // Aplicar las correcciones a los archivos
            filesNeedingCorrection.forEach(item => {
                const index = item.index;
                if (correctedFiles[index]) {
                    // Reemplazar el archivo original con el corregido
                    const correctedBlob = correctedFiles[index];
                    const originalFile = selectedFiles[index];
                    
                    // Crear un nuevo archivo con la imagen corregida
                    const correctedFile = new File(
                        [correctedBlob], 
                        originalFile.name, 
                        { type: 'image/jpeg' }
                    );
                    
                    // Mantener las propiedades del archivo original
                    correctedFile.status = originalFile.status;
                    correctedFile.progress = originalFile.progress;
                    
                    // Reemplazar en la lista
                    selectedFiles[index] = correctedFile;
                    item.corrected = true;
                }
            });
            
            // Ocultar la sección de corrección
            document.getElementById('orientation-correction').classList.add('hidden');
            
            // Actualizar la lista de archivos
            renderFilesList();
            
            // Mostrar notificación
            alert(`Se han corregido ${filesNeedingCorrection.length} imágenes. Ahora puedes subirlas.`);
        }

        function skipOrientationCorrection() {
            // Ocultar la sección de corrección sin aplicar cambios
            document.getElementById('orientation-correction').classList.add('hidden');
            
            // Marcar los archivos como que no necesitan corrección
            filesNeedingCorrection.forEach(item => {
                item.corrected = false;
            });
        }

        async function uploadAllFiles() {
            if (selectedFiles.length === 0 || isUploading) return;
            
            isUploading = true;
            currentUploadIndex = 0;
            totalUploadsCompleted = 0;
            totalUploadsFailed = 0;
            
            // Update UI
            document.getElementById('upload-prompt').classList.add('hidden');
            document.getElementById('upload-status').classList.remove('hidden');
            document.getElementById('upload-area').classList.add('uploading');
            
            // Initialize all files as pending
            selectedFiles.forEach(file => {
                file.status = 'pending';
                file.progress = 0;
            });
            
            renderFilesList();
            
            // Process files one by one
            await processUploadQueue();
            
            // Final summary
            isUploading = false;
            document.getElementById('upload-prompt').classList.remove('hidden');
            document.getElementById('upload-status').classList.add('hidden');
            document.getElementById('upload-area').classList.remove('uploading');
            
            // Show summary
            alert(`Proceso completado:\n${totalUploadsCompleted} archivos subidos con éxito\n${totalUploadsFailed} archivos con errores`);
            
            // Refresh data
            fetchPhotos();
            fetchStats();
            
            // Clear the list after successful upload
            if (totalUploadsCompleted > 0) {
                clearFileList();
            }
        }

        async function processUploadQueue() {
            while (currentUploadIndex < selectedFiles.length) {
                const file = selectedFiles[currentUploadIndex];
                
                // Update file status to uploading
                file.status = 'uploading';
                file.progress = 0;
                renderFilesList();
                
                try {
                    await uploadSingleFile(file, currentUploadIndex);
                    totalUploadsCompleted++;
                } catch (error) {
                    console.error(`Error uploading ${file.name}:`, error);
                    file.status = 'error';
                    totalUploadsFailed++;
                }
                
                currentUploadIndex++;
            }
        }

        async function uploadSingleFile(file, index) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                
                const xhr = new XMLHttpRequest();
                
                // Update progress
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        file.progress = percentComplete;
                        
                        // Update progress bar
                        const progressBar = document.getElementById(`progress-${index}`);
                        if (progressBar) {
                            progressBar.style.width = `${percentComplete}%`;
                        }
                    }
                });
                
                // Handle response
                xhr.addEventListener('load', () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                file.status = 'success';
                                file.facesDetected = response.faces_detected;
                                resolve(response);
                            } else {
                                file.status = 'error';
                                file.errorMessage = response.detail || 'Error desconocido';
                                reject(new Error(file.errorMessage));
                            }
                        } catch (e) {
                            file.status = 'error';
                            file.errorMessage = 'Error parsing response';
                            reject(new Error(file.errorMessage));
                        }
                    } else {
                        file.status = 'error';
                        file.errorMessage = `HTTP ${xhr.status}`;
                        reject(new Error(file.errorMessage));
                    }
                    
                    renderFilesList();
                });
                
                // Handle errors
                xhr.addEventListener('error', () => {
                    file.status = 'error';
                    file.errorMessage = 'Network error';
                    renderFilesList();
                    reject(new Error(file.errorMessage));
                });
                
                // Send request
                xhr.open('POST', `${API}/upload-photo`, true);
                xhr.send(formData);
            });
        }

        // Reemplaza la función openWebcamPopup con esta versión corregida
async function openWebcamPopup() {
    if (isSearching) return;
    
    // Mostrar el pop-up
    document.getElementById('webcam-popup-overlay').classList.remove('hidden');
    
    // Actualizar estado
    document.getElementById('webcam-status').textContent = 'Iniciando cámara...';
    document.getElementById('capture-btn').disabled = true;
    
    try {
        // Verificar si el navegador soporta getUserMedia
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('Tu navegador no soporta acceso a la cámara');
        }

        // Intentar obtener la cámara frontal primero en dispositivos móviles
        let constraints = {
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: 'user'
            }
        };

        // En dispositivos móviles, intentar primero con la cámara frontal
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
            } catch (mobileError) {
                console.warn('Error con cámara frontal, intentando con cámara trasera:', mobileError);
                // Si falla la cámara frontal, intentar con la trasera
                constraints.video.facingMode = 'environment';
                webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
            }
        } else {
            // Para escritorio, usar configuración estándar
            webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
        }

        // Configurar el video
        const webcamVideo = document.getElementById('webcam-video');
        const webcamPlaceholder = document.getElementById('webcam-placeholder');
        
        // Asegurarse de que el video esté visible
        webcamVideo.style.display = 'block';
        webcamPlaceholder.style.display = 'none';
        
        webcamVideo.srcObject = webcamStream;
        
        // Esperar a que el video esté completamente cargado
        webcamVideo.onloadedmetadata = () => {
            // Forzar la reproducción del video
            webcamVideo.play().then(() => {
                // Asegurarse de que el video se muestre correctamente
                webcamVideo.style.width = '100%';
                webcamVideo.style.height = '100%';
                webcamVideo.style.objectFit = 'cover';
                
                document.getElementById('webcam-status').textContent = 'Cámara lista';
                document.getElementById('capture-btn').disabled = false;
                showWebcam = true;
            }).catch(error => {
                console.error('Error al reproducir el video:', error);
                document.getElementById('webcam-status').textContent = 'Error al reproducir video';
            });
        };

    } catch (error) {
        console.error('Error accessing webcam:', error);
        
        // Manejo específico de errores comunes en móviles
        let errorMessage = 'Error accediendo a la cámara: ';
        
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            errorMessage += 'Permiso denegado. Por favor, permite el acceso a la cámara en la configuración de tu navegador.';
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
            errorMessage += 'No se encontró ninguna cámara en tu dispositivo.';
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
            errorMessage += 'La cámara está siendo utilizada por otra aplicación.';
        } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
            errorMessage += 'La cámara no cumple con los requisitos necesarios.';
        } else if (error.name === 'TypeError' || error.name === 'TypeError') {
            errorMessage += 'Error en la configuración de la cámara.';
        } else {
            errorMessage += error.message;
        }
        
        alert(errorMessage);
        closeWebcamPopup();
    }
}

// También actualiza la función closeWebcamPopup para asegurar una limpieza adecuada
function closeWebcamPopup() {
    // Ocultar el pop-up
    document.getElementById('webcam-popup-overlay').classList.add('hidden');
    
    // Detener el stream de manera más robusta
    if (webcamStream) {
        webcamStream.getTracks().forEach(track => {
            track.stop();
            track.enabled = false;
        });
        webcamStream = null;
    }
    
    // Limpiar el elemento de video
    const webcamVideo = document.getElementById('webcam-video');
    webcamVideo.srcObject = null;
    webcamVideo.load(); // Forzar recarga del elemento
    
    // Mostrar placeholder
    document.getElementById('webcam-placeholder').style.display = 'flex';
    
    showWebcam = false;
}

        async function capturePhotoFromPopup() {
            if (isSearching || !webcamStream) return;

            const webcamVideo = document.getElementById('webcam-video');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Asegurarse de que el video esté listo
            if (webcamVideo.readyState !== 4) {
                alert('La cámara aún no está lista. Por favor, espera un momento.');
                return;
            }

            // Usar las dimensiones reales del video
            canvas.width = webcamVideo.videoWidth;
            canvas.height = webcamVideo.videoHeight;
            
            // Dibujar la imagen actual del video con la corrección del espejo
            ctx.save();
            ctx.scale(-1, 1); // Corregir el efecto espejo
            ctx.drawImage(webcamVideo, -canvas.width, 0, canvas.width, canvas.height);
            ctx.restore();

            // Convertir a blob con mejor calidad para móviles
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    alert('Error al capturar la imagen. Intenta de nuevo.');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', blob, 'webcam-capture.jpg');
                
                // Mostrar indicador de progreso
                const captureBtn = document.getElementById('capture-btn');
                const originalText = captureBtn.textContent;
                captureBtn.textContent = '⏳ Buscando...';
                captureBtn.disabled = true;
                
                // Cerrar el pop-up mientras se busca
                closeWebcamPopup();
                
                await performSearch(formData);
                
                // Restaurar botón
                captureBtn.textContent = originalText;
                captureBtn.disabled = false;
            }, 'image/jpeg', 0.9); // Mayor calidad para móviles
        }

        // Search functions
        async function searchWithFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            await performSearch(formData);
            event.target.value = '';
        }

        async function performSearch(formData) {
            isSearching = true;
            
            try {
                console.log('Searching faces at:', API + '/search-face?threshold=' + searchThreshold);
                const response = await fetch(API + '/search-face?threshold=' + searchThreshold, {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response body:', errorText);
                    throw new Error('HTTP ' + response.status + ': ' + (errorText || 'Error desconocido'));
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const responseText = await response.text();
                    console.error('Non-JSON response:', responseText.substring(0, 200));
                    throw new Error('El servidor no devolvió JSON. Posible error 404 o problema en el endpoint.');
                }

                const data = await response.json();
                console.log('Search response:', data);

                if (data.success) {
                    searchResults = data.matches || [];
                    
                    if (data.matches_found > 0) {
                        const matchedPhotoIds = [...new Set(data.matches.map(match => match.photo_id))];
                        filteredPhotos = uploadedPhotos.filter(photo => matchedPhotoIds.includes(photo.id));
                        isSearchMode = true;
                        switchTab('gallery');
                        
                        alert('Encontré ' + data.matches_found + ' coincidencias en ' + filteredPhotos.length + ' fotos!');
                    } else {
                        filteredPhotos = [];
                        isSearchMode = false;
                        alert('No se encontraron coincidencias con el umbral actual.');
                    }
                    
                    renderPhotos();
                    renderResults();
                } else {
                    alert('Error en la búsqueda: ' + (data.detail || data.message || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Search error:', error);
                if (error.message.includes('<!DOCTYPE')) {
                    alert('Error: El servidor devolvió HTML en lugar de JSON. Verifica que el endpoint /api/search-face existe en tu backend.');
                } else {
                    alert('Error buscando la cara: ' + error.message);
                }
            } finally {
                isSearching = false;
            }
        }

        function clearSearchFilter() {
            isSearchMode = false;
            filteredPhotos = [];
            searchResults = [];
            renderPhotos();
        }

        // Photo deletion
        async function deletePhoto(photoId) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta foto?')) return;

            try {
                const response = await fetch(`${API}/photos/${photoId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Foto eliminada correctamente');
                    await fetchPhotos();
                    await fetchStats();
                } else {
                    alert('Error eliminando la foto: ' + (data.detail || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error eliminando la foto: ' + error.message);
            }
        }

        // Rendering functions
        function renderPhotos() {
            const container = document.getElementById('photos-container');
            const photosToShow = isSearchMode ? filteredPhotos : uploadedPhotos;
            
            // Update gallery header
            const galleryTitle = document.getElementById('gallery-title');
            const gallerySubtitle = document.getElementById('gallery-subtitle');
            const searchModeIndicator = document.getElementById('search-mode-indicator');
            const clearSearchBtn = document.getElementById('clear-search-btn');

            if (isSearchMode) {
                galleryTitle.textContent = 'Fotos con Coincidencias';
                gallerySubtitle.textContent = filteredPhotos.length + ' fotos con coincidencias de búsqueda';
                searchModeIndicator.classList.remove('hidden');
                clearSearchBtn.classList.remove('hidden');
            } else {
                galleryTitle.textContent = 'Galería de Fotos';
                gallerySubtitle.textContent = uploadedPhotos.length + ' fotos en total';
                searchModeIndicator.classList.add('hidden');
                clearSearchBtn.classList.add('hidden');
            }

            if (photosToShow.length === 0) {
                const emptyTitle = isSearchMode ? 'No hay coincidencias' : 'No hay fotos aún';
                const emptySubtitle = isSearchMode 
                    ? 'Intenta ajustar el umbral de búsqueda o busca otra persona'
                    : '¡Sube algunas fotos para comenzar!';

                container.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-icon">🖼️</div>' +
                    '<h3 class="empty-title">' + emptyTitle + '</h3>' +
                    '<p class="empty-subtitle">' + emptySubtitle + '</p>' +
                    (isSearchMode ? 
                        '<div class="empty-actions">' +
                            '<button class="btn btn-primary" onclick="switchTab(\'search\')">' +
                                'Nueva Búsqueda' +
                            '</button>' +
                            '<button class="btn btn-ghost" onclick="clearSearchFilter()">' +
                                'Ver Todas las Fotos' +
                            '</button>' +
                        '</div>' : '') +
                    '</div>';
                return;
            }

            const photosGrid = document.createElement('div');
            photosGrid.className = 'photos-grid';

            photosToShow.forEach(photo => {
                let matchInfo = null;
                if (isSearchMode && searchResults.length > 0) {
                    const photoMatches = searchResults.filter(match => match.photo_id === photo.id);
                    if (photoMatches.length > 0) {
                        const bestMatch = photoMatches.reduce((best, current) => 
                            current.similarity > best.similarity ? current : best
                        );
                        matchInfo = {
                            count: photoMatches.length,
                            bestSimilarity: bestMatch.similarity
                        };
                    }
                }

                const photoCard = document.createElement('div');
                photoCard.className = 'photo-card' + (isSearchMode ? ' photo-card-match' : '');
                photoCard.onclick = () => openPhotoPopup(photo.id);

                const matchBadge = isSearchMode && matchInfo ? 
                    '<div class="match-badge">🎯 ' + Math.round(matchInfo.bestSimilarity * 100) + '%</div>' : '';
                
                const matchInfoText = isSearchMode && matchInfo ? 
                    '<p class="match-info">' + matchInfo.count + ' coincidencia' + (matchInfo.count > 1 ? 's' : '') + '</p>' : '';

                photoCard.innerHTML = '<div class="photo-image">' +
                        '<img src="' + API + '/image/photo/' + photo.id + '" alt="' + photo.filename + '" ' +
                             'onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">' +
                        '<div class="photo-placeholder" style="display: none;">🖼️</div>' +
                        '<div class="photo-badge">' + photo.faces_count + ' caras</div>' +
                        matchBadge +
                    '</div>' +
                    '<div class="photo-info">' +
                        '<h4 class="photo-title">' + photo.filename + '</h4>' +
                        '<p class="photo-date">' + new Date(photo.upload_date).toLocaleDateString() + '</p>' +
                        matchInfoText +
                        '<div class="photo-actions">' +
                            '<button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deletePhoto(\'' + photo.id + '\')">' +
                                '🗑️ Eliminar' +
                            '</button>' +
                        '</div>' +
                    '</div>';

                photosGrid.appendChild(photoCard);
            });

            container.innerHTML = '';
            container.appendChild(photosGrid);
        }

        function renderResults() {
            const container = document.getElementById('results-container');

            if (searchResults.length === 0) {
                container.innerHTML = '<div class="empty-state">' +
                        '<div class="empty-icon">🎯</div>' +
                        '<h3 class="empty-title">No hay resultados aún</h3>' +
                        '<p class="empty-subtitle">Usa la función de búsqueda para encontrar coincidencias</p>' +
                        '<button class="btn btn-primary" onclick="switchTab(\'search\')">' +
                            'Comenzar Búsqueda' +
                        '</button>' +
                    '</div>';
                return;
            }

            let resultsHTML = '<div class="results-section">' +
                '<div class="results-header">' +
                    '<div class="results-info">' +
                        '<h3 class="results-title">Resultados de Búsqueda</h3>' +
                        '<p class="results-subtitle">' + searchResults.length + ' coincidencias encontradas</p>' +
                    '</div>' +
                    '<button class="btn btn-ghost" onclick="clearResults()">' +
                        'Limpiar resultados' +
                    '</button>' +
                '</div>' +
                '<div class="results-grid">';

            searchResults.forEach((result, index) => {
                resultsHTML += '<div class="result-card" onclick="openPhotoPopupFromResult(\'' + result.photo_id + '\')">' +
                        '<div class="result-image">' +
                            '<img src="' + API + '/image/photo/' + result.photo_id + '" alt="' + result.photo_filename + '"' +
                                 ' onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">' +
                            '<div class="result-placeholder" style="display: none;">🖼️</div>' +
                            '<div class="result-rank">#' + (index + 1) + '</div>' +
                            '<div class="result-similarity">' + Math.round(result.similarity * 100) + '%</div>' +
                        '</div>' +
                        '<div class="result-info">' +
                            '<h4 class="result-title">' + result.photo_filename + '</h4>' +
                            '<p class="result-score">Similitud: ' + Math.round(result.similarity * 100) + '%</p>' +
                            '<p class="result-id">ID: ' + result.face_id.slice(0, 8) + '...</p>' +
                        '</div>' +
                    '</div>';
            });

            resultsHTML += '</div></div>';
            container.innerHTML = resultsHTML;
        }

        function renderClients() {
            const container = document.getElementById('clients-container');
            
            if (searchedClients.length === 0) {
                container.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-icon">👥</div>' +
                    '<h3 class="empty-title">No hay clientes aún</h3>' +
                    '<p class="empty-subtitle">Los clientes que busquen sus fotos aparecerán aquí</p>' +
                    '</div>';
                return;
            }

            const clientsGrid = document.createElement('div');
            clientsGrid.className = 'clients-grid';

            searchedClients.forEach(client => {
                const clientCard = document.createElement('div');
                clientCard.className = 'client-card';

                // Construir URL correctamente para las imágenes de caras
                let faceImageUrl = null;
                
                if (client.face_image_path) {
                    // Asegurarse de que no haya duplicados en la ruta
                    const filename = client.face_image_path.replace(/^\/+/, '').replace(/\/+/g, '/');
                    faceImageUrl = `${BACKEND_URL}/faces/${filename}`;
                }
                
                console.log('Cliente:', client);
                console.log('face_image_path:', client.face_image_path);
                console.log('URL construida:', faceImageUrl);

                const matchInfo = client.best_match_photo_id ? 
                    '<div class="client-match">' +
                        '<div class="client-match-info">Mejor coincidencia:</div>' +
                        '<div>' + (client.best_match_filename || 'Desconocido') + '</div>' +
                    '</div>' +
                    '<div class="client-similarity">' +
                        'Similitud: <span class="client-similarity-value">' + 
                        (client.best_match_similarity ? Math.round(client.best_match_similarity * 100) + '%' : 'N/A') + 
                        '</span>' +
                    '</div>' : 
                    '<div class="client-match">' +
                        '<div class="client-match-info">Sin coincidencias</div>' +
                    '</div>';

                clientCard.innerHTML = '<div class="client-header">' +
                        '<div class="client-phone">' + client.phone_number + '</div>' +
                        '<div class="client-date">' + new Date(client.search_date).toLocaleDateString() + '</div>' +
                    '</div>' +
                    '<div class="client-content">' +
                        '<div class="client-image">' +
                            (faceImageUrl ? 
                                '<img src="' + faceImageUrl + '" alt="Cara del cliente" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">' +
                                '<div class="client-image-placeholder" style="display: none;">👤</div>' :
                                '<div class="client-image-placeholder">👤</div>'
                            ) +
                        '</div>' +
                        '<div class="client-info">' +
                            matchInfo +
                        '</div>' +
                    '</div>';

                clientsGrid.appendChild(clientCard);
            });

            container.innerHTML = '';
            container.appendChild(clientsGrid);
        }

        function clearResults() {
            searchResults = [];
            renderResults();
        }

        function refreshClients() {
            fetchSearchedClients();
        }

        // Photo popup functions
        function openPhotoPopup(photoId) {
            const photo = uploadedPhotos.find(p => p.id === photoId);
            if (!photo) return;

            selectedPhoto = photo;
            
            document.getElementById('popup-filename').textContent = photo.filename;
            document.getElementById('popup-date').textContent = new Date(photo.upload_date).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('popup-faces-count').textContent = photo.faces_count;
            document.getElementById('popup-file-size').textContent = photo.file_size ? 
                Math.round(photo.file_size / 1024) + ' KB' : 'N/A';
            document.getElementById('popup-photo-id').textContent = photo.id;

            // Agregar la URL de la imagen
            const imageUrl = API + '/image/photo/' + photo.id;
            document.getElementById('popup-url').value = imageUrl;

            const popupImage = document.getElementById('popup-image');
            const popupPlaceholder = document.getElementById('popup-placeholder');
            
            popupImage.src = imageUrl;
            popupImage.style.display = 'block';
            popupPlaceholder.classList.add('hidden');
            
            popupImage.onerror = function() {
                this.style.display = 'none';
                popupPlaceholder.classList.remove('hidden');
            };

            const description = 'Esta foto contiene ' + photo.faces_count + ' ' + (photo.faces_count === 1 ? 'cara detectada' : 'caras detectadas') + '. Puedes imprimir esta imagen en formato A5 optimizado para una mejor calidad de impresión.';
            document.getElementById('popup-description').textContent = description;

            document.getElementById('photo-popup-overlay').classList.remove('hidden');
        }

        function openPhotoPopupFromResult(photoId) {
            openPhotoPopup(photoId);
        }

        function closePhotoPopup() {
            document.getElementById('photo-popup-overlay').classList.add('hidden');
            selectedPhoto = null;
        }

        function printPhoto() {
            if (!selectedPhoto) return;

            const printWindow = window.open('', '_blank');
            const imageUrl = API + '/image/photo/' + selectedPhoto.id;
            
            printWindow.document.write('<!DOCTYPE html>' +
                '<html>' +
                    '<head>' +
                        '<title>Imprimir Foto - ' + selectedPhoto.filename + '</title>' +
                        '<style>' +
                            '@page {' +
                                'size: A5;' +
                                'margin: 0;' +
                            '}' +
                            'body {' +
                                'margin: 0;' +
                                'padding: 0;' +
                                'display: flex;' +
                                'justify-content: center;' +
                                'align-items: center;' +
                                'height: 100vh;' +
                                'background: white;' +
                            '}' +
                            '.print-container {' +
                                'width: 148mm;' +
                                'height: 210mm;' +
                                'display: flex;' +
                                'justify-content: center;' +
                                'align-items: center;' +
                                'padding: 10mm;' +
                                'box-sizing: border-box;' +
                            '}' +
                            '.print-image {' +
                                'max-width: 100%;' +
                                'max-height: 100%;' +
                                'object-fit: contain;' +
                                'box-shadow: 0 2px 10px rgba(0,0,0,0.1);' +
                            '}' +
                            '@media print {' +
                                'body {' +
                                    'print-color-adjust: exact;' +
                                    '-webkit-print-color-adjust: exact;' +
                                '}' +
                            '}' +
                        '</style>' +
                    '</head>' +
                    '<body>' +
                        '<div class="print-container">' +
                            '<img src="' + imageUrl + '" alt="' + selectedPhoto.filename + '" class="print-image" onload="window.focus(); window.print(); window.close();" />' +
                        '</div>' +
                    '</body>' +
                '</html>');
            
            printWindow.document.close();
        }

        // Nuevas funciones para manejar la URL de la foto
        function copyPhotoUrl() {
            const urlInput = document.getElementById('popup-url');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999); // Para dispositivos móviles
            
            try {
                document.execCommand('copy');
                showCopyNotification();
            } catch (err) {
                // Fallback para navegadores que no soportan execCommand
                navigator.clipboard.writeText(urlInput.value).then(() => {
                    showCopyNotification();
                }).catch(err => {
                    console.error('Error al copiar URL: ', err);
                    alert('No se pudo copiar la URL. Por favor, cópiala manualmente.');
                });
            }
        }

        function openPhotoUrl() {
            const url = document.getElementById('popup-url').value;
            window.open(url, '_blank');
        }

        function showCopyNotification() {
            const notification = document.getElementById('copy-notification');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        // Clean up webcam when page is unloaded
        window.addEventListener('beforeunload', function() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
