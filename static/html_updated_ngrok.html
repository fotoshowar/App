<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOTOSHOW</title>
    <style>
        /* Mantengo todos los estilos existentes y a√±ado los nuevos */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f9fafb;
            color: #111827;
        }

        /* Dashboard Layout */
        .dashboard {
            min-height: 100vh;
            display: flex;
            background-color: #f9fafb;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 16rem;
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 50;
            display: flex;
            flex-direction: column;
        }

        .sidebar-open {
            transform: translateX(0);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 4rem;
            padding: 0 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 2rem;
            height: 2rem;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: bold;
            color: #111827;
        }

        .close-sidebar {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: #6b7280;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }

        .close-sidebar:hover {
            background-color: #f3f4f6;
            color: #111827;
        }

        .sidebar-nav {
            flex: 1;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            color: #6b7280;
            font-weight: 500;
            width: 100%;
        }

        .nav-item:hover {
            background-color: #f3f4f6;
            color: #111827;
        }

        .nav-item-active {
            background-color: #eff6ff;
            color: #1d4ed8;
            border-right: 2px solid #1d4ed8;
        }

        .nav-icon {
            font-size: 1.25rem;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-text {
            font-size: 0.875rem;
        }

        .sidebar-stats {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            background-color: #f9fafb;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #111827;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #6b7280;
        }

        /* Main Content - CORREGIDO */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-left: 0;
            width: 100%;
            transition: margin-left 0.3s ease;
            position: relative;
        }

        /* A√±adido para manejar mejor el estado de la barra lateral */
        .sidebar-open ~ .main-content {
            margin-left: 0;
        }

        .header {
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .menu-button {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: #6b7280;
            border-radius: 0.375rem;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .menu-button:hover {
            background-color: #f3f4f6;
            color: #111827;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0;
        }

        .page-icon {
            font-size: 1.25rem;
        }

        .page-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0.25rem 0 0 0;
        }

        .header-right {
            display: none;
        }

        .last-update {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .connection-status {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        /* Dashboard Content */
        .dashboard-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .metric-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .metric-info {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #111827;
        }

        .metric-icon {
            font-size: 2rem;
            opacity: 0.7;
        }

        .activity-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .activity-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            padding: 1.5rem 1.5rem 0 1.5rem;
            margin-bottom: 1rem;
        }

        .activity-list {
            padding: 0 1.5rem 1.5rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
        }

        .activity-icon {
            font-size: 1.25rem;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border-radius: 0.375rem;
        }

        .activity-info {
            flex: 1;
        }

        .activity-action {
            font-size: 0.875rem;
            font-weight: 500;
            color: #111827;
        }

        .activity-details {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .activity-time {
            font-size: 0.875rem;
            color: #9ca3af;
        }

        /* Upload Content */
        .upload-content {
            max-width: 40rem;
            margin: 0 auto;
        }

        .upload-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 2rem;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #9ca3af;
        }

        .drag-active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .uploading {
            border-color: #10b981;
            background-color: #f0fdf4;
        }

        .upload-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .spinner {
            font-size: 3rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .upload-prompt {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .upload-icon {
            font-size: 3rem;
            color: #9ca3af;
        }

        .upload-title {
            font-size: 1.125rem;
            font-weight: 500;
            color: #111827;
        }

        .upload-subtitle {
            color: #6b7280;
        }

        .upload-formats {
            font-size: 0.875rem;
            color: #9ca3af;
        }

        .upload-button {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .upload-button:hover {
            background-color: #2563eb;
        }

        .upload-text {
            font-size: 1.125rem;
            font-weight: 500;
            color: #3b82f6;
        }

        .upload-info {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        /* Nuevos estilos para la lista de archivos */
        .files-list {
            margin-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 1.5rem;
        }

        .files-list-title {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .files-count {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: normal;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s;
        }

        .file-item:hover {
            background-color: #f3f4f6;
        }

        .file-icon {
            font-size: 1.5rem;
            margin-right: 0.75rem;
            color: #6b7280;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: #111827;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .file-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .file-status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .file-status-uploading {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .file-status-success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .file-status-error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .file-status-orientation {
            background-color: #e0e7ff;
            color: #3730a3;
        }

        .file-progress {
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .file-progress-bar {
            height: 100%;
            background-color: #3b82f6;
            width: 0%;
            transition: width 0.3s;
        }

        .upload-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .btn-clear {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .btn-clear:hover {
            background-color: #e5e7eb;
            color: #374151;
        }

        /* Nuevos estilos para la correcci√≥n de orientaci√≥n */
        .orientation-correction {
            margin-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 1.5rem;
        }

        .orientation-title {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .orientation-icon {
            font-size: 1.2rem;
            color: #6366f1;
        }

        .orientation-preview {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .orientation-image-container {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .orientation-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .orientation-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .orientation-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .orientation-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .orientation-info {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background-color: #f0f9ff;
            border-radius: 0.5rem;
            border-left: 3px solid #3b82f6;
        }

        /* Search Content */
        .search-content {
            max-width: 32rem;
            margin: 0 auto;
        }

        .search-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 2rem;
        }

        .search-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1.5rem;
        }

        .search-info {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            color: #0369a1;
        }

        .threshold-control {
            margin-bottom: 2rem;
        }

        .threshold-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .threshold-slider {
            width: 100%;
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            outline: none;
            cursor: pointer;
        }

        .threshold-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .search-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .webcam-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .webcam-container {
            aspect-ratio: 16/9;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .webcam {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .webcam-placeholder {
            font-size: 3rem;
            color: #9ca3af;
        }

        .divider {
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .file-upload-area:hover {
            border-color: #9ca3af;
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .file-upload-icon {
            font-size: 2rem;
            color: #9ca3af;
        }

        .file-upload-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: #111827;
        }

        .file-upload-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .hidden-input {
            display: none;
        }

        /* Gallery Content */
        .gallery-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .gallery-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .gallery-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .gallery-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .gallery-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
        }

        /* Search Mode Indicator */
        .search-mode-indicator {
            margin-bottom: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 1px solid #90caf9;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .search-mode-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #2196f3, #9c27b0, #2196f3);
            background-size: 200% 100%;
            animation: searchIndicatorGlow 2s linear infinite;
        }

        .search-indicator-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .search-indicator-icon {
            font-size: 20px;
            margin-right: 5px;
        }

        .search-indicator-text {
            flex: 1;
            min-width: 250px;
            color: #1565c0;
            font-weight: 500;
            font-size: 14px;
        }

        @keyframes searchIndicatorGlow {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        @media (min-width: 1200px) {
            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        @media (min-width: 1400px) {
            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        .photo-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .photo-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .photo-card-match {
            border: 2px solid #4caf50;
            background: linear-gradient(135deg, #ffffff 0%, #f1f8e9 100%);
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.25);
            position: relative;
        }

        .photo-card-match::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #4caf50, #8bc34a, #4caf50);
            border-radius: inherit;
            z-index: -1;
            opacity: 0.3;
        }

        .photo-image {
            aspect-ratio: 1;
            position: relative;
            overflow: hidden;
        }

        .photo-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-placeholder {
            width: 100%;
            height: 100%;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #9ca3af;
        }

        .photo-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .match-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2;
        }

        .photo-info {
            padding: 1rem;
        }

        .photo-title {
            font-weight: 500;
            color: #111827;
            margin: 0 0 0.25rem 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .photo-date {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0 0 0.75rem 0;
        }

        .match-info {
            color: #2e7d32;
            font-size: 12px;
            font-weight: 500;
            margin: 4px 0;
            padding: 2px 6px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 4px;
            display: inline-block;
        }

        .photo-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .photo-actions .btn {
            flex: 1;
            min-width: 80px;
        }

        /* Results Content */
        .results-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .results-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .results-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        @media (min-width: 1200px) {
            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        @media (min-width: 1400px) {
            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        .result-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .result-image {
            aspect-ratio: 1;
            position: relative;
            overflow: hidden;
        }

        .result-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .result-placeholder {
            width: 100%;
            height: 100%;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #9ca3af;
        }

        .result-rank {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background-color: #3b82f6;
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }

        .result-similarity {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #10b981;
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }

        .result-info {
            padding: 1rem;
        }

        .result-title {
            font-weight: 500;
            color: #111827;
            margin: 0 0 0.25rem 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .result-score {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0 0 0.25rem 0;
        }

        .result-id {
            font-size: 0.75rem;
            color: #9ca3af;
            margin: 0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #9ca3af;
        }

        .empty-title {
            font-size: 1.125rem;
            font-weight: 500;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        .empty-subtitle {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .empty-actions {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.875rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #059669;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
        }

        .btn-ghost {
            background-color: transparent;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .btn-ghost:hover {
            background-color: #f3f4f6;
            color: #111827;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #2196f3;
            color: #2196f3;
        }

        .btn-outline:hover {
            background: #2196f3;
            color: white;
        }

        .btn-full {
            width: 100%;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn-icon {
            padding: 8px 12px;
            min-width: auto;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Photo Popup */
        .photo-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        .photo-popup {
            background: white;
            border-radius: 16px;
            max-width: 90vw;
            max-height: 90vh;
            width: 800px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .photo-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e5e5;
            background: #f8f9fa;
        }

        .photo-popup-title h3 {
            margin: 0 0 4px 0;
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .photo-popup-date {
            margin: 0;
            font-size: 14px;
            color: #64748b;
        }

        .photo-popup-actions {
            display: flex;
            gap: 8px;
        }

        .photo-popup-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .photo-popup-image {
            flex: 1;
            position: relative;
            background: #f1f5f9;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .photo-popup-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .photo-popup-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #64748b;
            text-align: center;
        }

        .placeholder-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .placeholder-text {
            font-size: 16px;
            font-weight: 500;
        }

        .photo-popup-info {
            width: 280px;
            background: #fafbfc;
            padding: 24px;
            border-left: 1px solid #e5e5e5;
            overflow-y: auto;
        }

        .photo-info-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
        }

        .info-value {
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
        }

        .photo-popup-description {
            padding-top: 16px;
            border-top: 1px solid #e5e5e5;
        }

        .photo-popup-description p {
            margin: 0;
            font-size: 14px;
            line-height: 1.6;
            color: #4a5568;
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .metric-card,
        .activity-card,
        .upload-card,
        .search-card,
        .photo-card,
        .result-card {
            animation: fadeIn 0.3s ease-out;
        }

        /* Scrollbar */
        .content::-webkit-scrollbar {
            width: 6px;
        }

        .content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Responsive Design - CORREGIDO COMPLETAMENTE */
        @media (min-width: 1024px) {
            .sidebar {
                position: static;
                transform: none;
                width: 14rem;
                flex-shrink: 0;
            }

            .main-content {
                margin-left: 0;
                width: auto;
                flex: 1;
            }

            .menu-button {
                display: none;
            }

            .close-sidebar {
                display: none;
            }

            .header-right {
                display: block;
            }

            .sidebar-overlay {
                display: none;
            }
        }

        @media (max-width: 1023px) {
            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
            }
        }

        @media (min-width: 768px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .gallery-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-indicator-content {
                flex-direction: column;
                align-items: flex-start;
                text-align: center;
            }
            
            .search-indicator-text {
                min-width: auto;
            }
            
            .empty-actions {
                flex-direction: column;
            }
            
            .photo-card-match {
                transform: none;
            }

            .photo-popup {
                width: 95vw;
                height: 90vh;
                max-height: none;
            }
            
            .photo-popup-content {
                flex-direction: column;
            }
            
            .photo-popup-image {
                min-height: 250px;
                flex: 0 0 auto;
            }
            
            .photo-popup-info {
                width: 100%;
                max-height: 200px;
                border-left: none;
                border-top: 1px solid #e5e5e5;
            }
        }

        @media (min-width: 640px) {
            .content {
                padding: 1.5rem;
            }

            .upload-content,
            .search-content {
                max-width: 36rem;
            }
        }

        /* Hidden elements */
        .hidden {
            display: none;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Clientes buscados */
        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .client-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .client-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .client-header {
            padding: 1rem;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .client-phone {
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .client-date {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .client-content {
            padding: 1rem;
            display: flex;
            gap: 1rem;
        }

        .client-image {
            width: 80px;
            height: 80px;
            border-radius: 0.5rem;
            overflow: hidden;
            flex-shrink: 0;
        }

        .client-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .client-image-placeholder {
            width: 100%;
            height: 100%;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #9ca3af;
        }

        .client-info {
            flex: 1;
        }

        .client-match {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .client-match-info {
            font-weight: 500;
            color: #111827;
        }

        .client-similarity {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .client-similarity-value {
            font-weight: 600;
            color: #10b981;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">üîç</div>
                    <span class="logo-text">FOTOSHOW</span>
                </div>
                <button class="close-sidebar" onclick="closeSidebar()">‚úï</button>
            </div>

            <nav class="sidebar-nav">
                <button class="nav-item nav-item-active" data-tab="dashboard" onclick="switchTab('dashboard')">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">Panel Principal</span>
                </button>
                <button class="nav-item" data-tab="upload" onclick="switchTab('upload')">
                    <span class="nav-icon">üì§</span>
                    <span class="nav-text">Subir Fotos</span>
                </button>
                <button class="nav-item" data-tab="search" onclick="switchTab('search')">
                    <span class="nav-icon">üîç</span>
                    <span class="nav-text">Buscar Cara</span>
                </button>
                <button class="nav-item" data-tab="gallery" onclick="switchTab('gallery')">
                    <span class="nav-icon">üñºÔ∏è</span>
                    <span class="nav-text">Galer√≠a</span>
                </button>
                <button class="nav-item" data-tab="results" onclick="switchTab('results')">
                    <span class="nav-icon">üéØ</span>
                    <span class="nav-text">Resultados</span>
                </button>
                <button class="nav-item" data-tab="clients" onclick="switchTab('clients')">
                    <span class="nav-icon">üë•</span>
                    <span class="nav-text">Clientes Buscados</span>
                </button>
            </nav>

            <div class="sidebar-stats">
                <div class="stat-item">
                    <div class="stat-number" id="total-photos">0</div>
                    <div class="stat-label">Fotos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-faces">0</div>
                    <div class="stat-label">Caras</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="menu-button" onclick="openSidebar()">‚ò∞</button>
                    
                    <div class="header-info">
                        <h1 class="page-title">
                            <span class="page-icon" id="page-icon">üìä</span>
                            <span id="page-title-text">Panel Principal</span>
                        </h1>
                        <p class="page-subtitle" id="page-subtitle">Resumen general de tu colecci√≥n</p>
                    </div>
                </div>

                <div class="header-right">
                    <span class="last-update">
                        √öltima actualizaci√≥n: <span id="last-update-time"></span>
                    </span>
                    <div class="connection-status">
                        Backend: <span id="backend-url"></span>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <main class="content">
                <!-- Dashboard Tab -->
                <div id="dashboard-tab" class="tab-content active">
                    <div class="dashboard-content">
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-info">
                                    <div class="metric-label">Total Fotos</div>
                                    <div class="metric-value" id="dashboard-total-photos">0</div>
                                </div>
                                <div class="metric-icon">üñºÔ∏è</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-info">
                                    <div class="metric-label">Caras Detectadas</div>
                                    <div class="metric-value" id="dashboard-total-faces">0</div>
                                </div>
                                <div class="metric-icon">üë•</div>
                            </div>

                            <div class="metric-card">
                                <div class="metric-info">
                                    <div class="metric-label">B√∫squedas</div>
                                    <div class="metric-value" id="dashboard-searches">0</div>
                                </div>
                                <div class="metric-icon">üîç</div>
                            </div>

                            <div class="metric-card">
                                <div class="metric-info">
                                    <div class="metric-label">Clientes</div>
                                    <div class="metric-value" id="dashboard-clients">0</div>
                                </div>
                                <div class="metric-icon">üë•</div>
                            </div>
                        </div>

                        <div class="activity-card">
                            <h3 class="activity-title">Actividad Reciente</h3>
                            <div class="activity-list">
                                <div class="activity-item">
                                    <div class="activity-icon">üì§</div>
                                    <div class="activity-info">
                                        <div class="activity-action">Foto subida</div>
                                        <div class="activity-details">family_reunion.jpg - 6 caras detectadas</div>
                                    </div>
                                    <div class="activity-time">Hace 2 min</div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">üîç</div>
                                    <div class="activity-info">
                                        <div class="activity-action">B√∫squeda realizada</div>
                                        <div class="activity-details">selfie_search.jpg - 3 caras detectadas</div>
                                    </div>
                                    <div class="activity-time">Hace 15 min</div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">üì§</div>
                                    <div class="activity-info">
                                        <div class="activity-action">Foto subida</div>
                                        <div class="activity-details">birthday_party.jpg - 8 caras detectadas</div>
                                    </div>
                                    <div class="activity-time">Hace 1 hora</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Tab -->
                <div id="upload-tab" class="tab-content">
                    <div class="upload-content">
                        <div class="upload-card">
                            <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                                <input type="file" id="file-input" class="hidden-input" accept="image/*" multiple onchange="handleFileUpload(event)">
                                
                                <div class="upload-prompt" id="upload-prompt">
                                    <div class="upload-icon">üì∑</div>
                                    <div class="upload-title">Sube tus fotos</div>
                                    <div class="upload-subtitle">Arrastra archivos aqu√≠ o haz clic para seleccionar</div>
                                    <div class="upload-formats">JPG ‚Ä¢ PNG ‚Ä¢ GIF ‚Ä¢ WebP</div>
                                    <button class="upload-button">Seleccionar Archivos</button>
                                </div>

                                <div class="upload-status hidden" id="upload-status">
                                    <div class="spinner">‚è≥</div>
                                    <div class="upload-text">Procesando im√°genes...</div>
                                    <div class="upload-subtitle">Detectando caras autom√°ticamente</div>
                                </div>
                            </div>
                            
                            <!-- Lista de archivos seleccionados -->
                            <div class="files-list hidden" id="files-list">
                                <div class="files-list-title">
                                    Archivos seleccionados
                                    <span class="files-count" id="files-count">0 archivos</span>
                                </div>
                                <div id="files-container"></div>
                                
                                <div class="upload-actions">
                                    <button class="btn btn-primary" onclick="uploadAllFiles()">
                                        Subir Todos los Archivos
                                    </button>
                                    <button class="btn btn-clear" onclick="clearFileList()">
                                        Limpiar Lista
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Secci√≥n de correcci√≥n de orientaci√≥n -->
                            <div class="orientation-correction hidden" id="orientation-correction">
                                <div class="orientation-title">
                                    <span class="orientation-icon">üîÑ</span>
                                    Correcci√≥n de Orientaci√≥n
                                </div>
                                <div class="orientation-info">
                                    Hemos detectado que algunas fotos pueden estar en una orientaci√≥n incorrecta. Puedes corregirlas autom√°ticamente antes de subirlas.
                                </div>
                                <div class="orientation-preview" id="orientation-preview">
                                    <!-- Las im√°genes se agregar√°n din√°micamente -->
                                </div>
                                <div class="orientation-actions">
                                    <button class="btn btn-primary" onclick="applyOrientationCorrection()">
                                        Aplicar Correcci√≥n
                                    </button>
                                    <button class="btn btn-ghost" onclick="skipOrientationCorrection()">
                                        Omitir Correcci√≥n
                                    </button>
                                </div>
                            </div>
                            
                            <div class="upload-info">
                                Las caras se detectan autom√°ticamente y se indexan para b√∫squedas futuras
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Tab -->
                <div id="search-tab" class="tab-content">
                    <div class="search-content">
                        <div class="search-card">
                            <h3 class="search-title">Configuraci√≥n de B√∫squeda</h3>
                            
                            <div class="search-info">
                                <strong>Importante:</strong> Las fotos que uses para buscar no se guardar√°n en tu galer√≠a. Solo se usar√°n para encontrar coincidencias en tus fotos existentes.
                            </div>
                            
                            <div class="threshold-control">
                                <label class="threshold-label" for="threshold-slider">
                                    Umbral de Similitud: <span id="threshold-display">70%</span>
                                </label>
                                <input type="range" id="threshold-slider" min="50" max="95" step="5" value="70" class="threshold-slider" oninput="updateThreshold(this.value)">
                                <div class="threshold-labels">
                                    <span>M√°s coincidencias</span>
                                    <span>Mayor precisi√≥n</span>
                                </div>
                            </div>

                            <div class="search-options">
                                <button class="btn btn-success btn-full" onclick="toggleWebcam()" id="webcam-btn">
                                    üì∑ Usar C√°mara Web
                                </button>

                                <div class="webcam-section hidden" id="webcam-section">
                                    <div class="webcam-container">
                                        <video id="webcam" class="webcam" autoplay playsinline></video>
                                        <div class="webcam-placeholder" id="webcam-placeholder">üì∑</div>
                                    </div>
                                    <button class="btn btn-primary btn-full" onclick="capturePhoto()" id="capture-btn">
                                        Capturar y Buscar
                                    </button>
                                </div>

                                <div class="divider">o</div>

                                <div class="file-upload-area">
                                    <input type="file" id="search-file-input" class="hidden-input" accept="image/*" onchange="searchWithFile(event)">
                                    <label for="search-file-input" class="file-upload-label">
                                        <div class="file-upload-icon">üñºÔ∏è</div>
                                        <div class="file-upload-text">Subir Selfie</div>
                                        <div class="file-upload-subtitle">Para buscar en tu colecci√≥n</div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gallery Tab -->
                <div id="gallery-tab" class="tab-content">
                    <div class="gallery-content">
                        <div class="gallery-header">
                            <div class="gallery-info">
                                <h3 class="gallery-title" id="gallery-title">Galer√≠a de Fotos</h3>
                                <p class="gallery-subtitle" id="gallery-subtitle">0 fotos en total</p>
                            </div>
                            <div class="gallery-actions">
                                <button class="btn btn-ghost hidden" id="clear-search-btn" onclick="clearSearchFilter()">
                                    üîÑ Ver Todas las Fotos
                                </button>
                                <button class="btn btn-primary" onclick="switchTab('upload')">
                                    ‚ûï A√±adir Fotos
                                </button>
                            </div>
                        </div>

                        <div class="search-mode-indicator hidden" id="search-mode-indicator">
                            <div class="search-indicator-content">
                                <span class="search-indicator-icon">üéØ</span>
                                <span class="search-indicator-text">
                                    Mostrando solo fotos que contienen coincidencias de tu b√∫squeda
                                </span>
                                <button class="btn btn-small btn-outline" onclick="switchTab('results')">
                                    Ver Detalles
                                </button>
                            </div>
                        </div>

                        <div id="photos-container">
                            <div class="empty-state">
                                <div class="empty-icon">üñºÔ∏è</div>
                                <h3 class="empty-title">No hay fotos a√∫n</h3>
                                <p class="empty-subtitle">¬°Sube algunas fotos para comenzar!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Tab -->
                <div id="results-tab" class="tab-content">
                    <div class="results-content">
                        <div id="results-container">
                            <div class="empty-state">
                                <div class="empty-icon">üéØ</div>
                                <h3 class="empty-title">No hay resultados a√∫n</h3>
                                <p class="empty-subtitle">Usa la funci√≥n de b√∫squeda para encontrar coincidencias</p>
                                <button class="btn btn-primary" onclick="switchTab('search')">
                                    Comenzar B√∫squeda
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clients Tab -->
                <div id="clients-tab" class="tab-content">
                    <div class="gallery-content">
                        <div class="gallery-header">
                            <div class="gallery-info">
                                <h3 class="gallery-title">Clientes que buscaron sus fotos</h3>
                                <p class="gallery-subtitle" id="clients-subtitle">0 clientes en total</p>
                            </div>
                            <div class="gallery-actions">
                                <button class="btn btn-ghost" onclick="refreshClients()">
                                    üîÑ Actualizar Lista
                                </button>
                            </div>
                        </div>

                        <div id="clients-container">
                            <div class="empty-state">
                                <div class="empty-icon">üë•</div>
                                <h3 class="empty-title">No hay clientes a√∫n</h3>
                                <p class="empty-subtitle">Los clientes que busquen sus fotos aparecer√°n aqu√≠</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
    </div>

    <!-- Photo Popup -->
    <div class="photo-popup-overlay hidden" id="photo-popup-overlay" onclick="closePhotoPopup()">
        <div class="photo-popup" onclick="event.stopPropagation()">
            <div class="photo-popup-header">
                <div class="photo-popup-title">
                    <h3 id="popup-filename">Nombre del archivo</h3>
                    <p class="photo-popup-date" id="popup-date">Fecha de subida</p>
                </div>
                <div class="photo-popup-actions">
                    <button class="btn btn-success btn-icon" onclick="printPhoto()" title="Imprimir en A5">
                        üñ®Ô∏è Imprimir A5
                    </button>
                    <button class="btn btn-ghost btn-icon" onclick="closePhotoPopup()" title="Cerrar">
                        ‚úï
                    </button>
                </div>
            </div>
            
            <div class="photo-popup-content">
                <div class="photo-popup-image">
                    <img id="popup-image" src="" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="photo-popup-placeholder hidden" id="popup-placeholder">
                        
                    </div>
                </div>
                
                <div class="photo-popup-info">
                    <div class="photo-info-grid">
                        <div class="info-item">
                            <span class="info-label">Caras detectadas:</span>
                            <span class="info-value" id="popup-faces-count">0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tama√±o del archivo:</span>
                            <span class="info-value" id="popup-file-size">N/A</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ID de la foto:</span>
                            <span class="info-value" id="popup-photo-id">N/A</span>
                        </div>
                    </div>
                    
                    <div class="photo-popup-description">
                        <p id="popup-description">
                            Esta foto contiene caras detectadas. Puedes imprimir esta imagen en formato A5 optimizado para una mejor calidad de impresi√≥n.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'dashboard';
        let uploadedPhotos = [];
        let searchResults = [];
        let isUploading = false;
        let isSearching = false;
        let showWebcam = false;
        let searchThreshold = 0.7;
        let stats = { total_photos: 0, total_faces: 0 };
        let isSearchMode = false;
        let filteredPhotos = [];
        let selectedPhoto = null;
        let webcamStream = null;
        let searchedClients = [];
        
        // Variables para la carga m√∫ltiple de archivos
        let selectedFiles = [];
        let fileUploadQueue = [];
        let currentUploadIndex = 0;
        let totalUploadsCompleted = 0;
        let totalUploadsFailed = 0;
        
        // Variables para la correcci√≥n de orientaci√≥n
        let filesNeedingCorrection = [];
        let correctedFiles = {};

        // CORRECCI√ìN: Funci√≥n para detectar si estamos accediendo localmente o por IP p√∫blica
        function getBackendURL() {
            const hostname = window.location.hostname;
            const port = window.location.port;
            const protocol = window.location.protocol;
            
            // Si estamos accediendo por localhost o 127.0.0.1, usar localhost
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:8888';
            }
            
            // Si estamos accediendo por la IP p√∫blica, usar la IP p√∫blica
            if (hostname === '191.97.117.104') {
                return 'http://191.97.117.104:8888';
            }
            
            // Para cualquier otro caso, usar la URL actual
            return `${protocol}//${hostname}${port ? ':' + port : ''}`;
        }

        const BACKEND_URL = getBackendURL();
        const API = `${BACKEND_URL}/api`;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Backend URL:', BACKEND_URL);
            console.log('API URL:', API);
            
            updateLastUpdateTime();
            document.getElementById('backend-url').textContent = BACKEND_URL;
            
            fetchPhotos();
            fetchStats();
            fetchSearchedClients();
            
            // Set up drag and drop for upload area
            setupDragAndDrop();
            
            // Update time every minute
            setInterval(updateLastUpdateTime, 60000);
        });

        // Navigation functions - CORREGIDAS
        function openSidebar() {
            document.getElementById('sidebar').classList.add('sidebar-open');
            document.getElementById('sidebar-overlay').classList.remove('hidden');
            // Aseg√∫rate de que el contenido principal no se desplace
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('sidebar-open');
            document.getElementById('sidebar-overlay').classList.add('hidden');
            // Restaura el scroll del cuerpo
            document.body.style.overflow = '';
        }

        function switchTab(tabName) {
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('nav-item-active');
                if (item.dataset.tab === tabName) {
                    item.classList.add('nav-item-active');
                }
            });

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');

            // Update page title and subtitle
            const pageInfo = {
                dashboard: { icon: 'üìä', title: 'Dashboard', subtitle: 'Resumen general de tu colecci√≥n' },
                upload: { icon: 'üì§', title: 'Subir Fotos', subtitle: 'Sube nuevas fotos para detectar caras' },
                search: { icon: 'üîç', title: 'Buscar Cara', subtitle: 'Busca caras en tu colecci√≥n' },
                gallery: { icon: 'üñºÔ∏è', title: 'Galer√≠a', subtitle: 'Explora todas tus fotos subidas' },
                results: { icon: 'üéØ', title: 'Resultados', subtitle: 'Resultados de tu √∫ltima b√∫squeda' },
                clients: { icon: 'üë•', title: 'Clientes Buscados', subtitle: 'Clientes que han buscado sus fotos' }
            };

            const info = pageInfo[tabName];
            document.getElementById('page-icon').textContent = info.icon;
            document.getElementById('page-title-text').textContent = info.title;
            document.getElementById('page-subtitle').textContent = info.subtitle;

            currentTab = tabName;
            closeSidebar();
        }

        // Utility functions
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update-time').textContent = now.toLocaleTimeString();
        }

        function updateThreshold(value) {
            searchThreshold = parseFloat(value) / 100;
            document.getElementById('threshold-display').textContent = value + '%';
        }

        // API functions
        async function fetchPhotos() {
            try {
                console.log('Fetching photos from:', `${API}/photos`);
                const response = await fetch(`${API}/photos`);
                const data = await response.json();
                console.log('Photos response:', data);
                if (data.success) {
                    uploadedPhotos = data.photos;
                    renderPhotos();
                }
            } catch (error) {
                console.error('Error fetching photos:', error);
            }
        }

        async function fetchStats() {
            try {
                console.log('Fetching stats from:', `${BACKEND_URL}/api-status`);
                const response = await fetch(`${BACKEND_URL}/api-status`);
                const data = await response.json();
                console.log('Stats response:', data);
                if (data.database) {
                    stats = data.database;
                    updateStatsDisplay();
                }
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        async function fetchSearchedClients() {
            try {
                console.log('Fetching searched clients from:', `${API}/searched-clients`);
                const response = await fetch(`${API}/searched-clients`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Searched clients response:', data);
                
                if (data.success) {
                    searchedClients = data.clients || [];
                    renderClients();
                    updateClientsStats();
                } else {
                    console.error('Error en la respuesta:', data.detail);
                    searchedClients = [];
                    renderClients();
                    updateClientsStats();
                }
            } catch (error) {
                console.error('Error fetching searched clients:', error);
                searchedClients = [];
                renderClients();
                updateClientsStats();
            }
        }

        function updateStatsDisplay() {
            document.getElementById('total-photos').textContent = stats.total_photos;
            document.getElementById('total-faces').textContent = stats.total_faces;
            document.getElementById('dashboard-total-photos').textContent = stats.total_photos;
            document.getElementById('dashboard-total-faces').textContent = stats.total_faces;
        }

        function updateClientsStats() {
            document.getElementById('dashboard-clients').textContent = searchedClients.length;
            document.getElementById('clients-subtitle').textContent = searchedClients.length + ' clientes en total';
        }

        // Upload functions
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-active');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-active');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-active');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    addFilesToQueue(files);
                }
            });
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                addFilesToQueue(files);
            }
        }

        function addFilesToQueue(files) {
            // Convert FileList to Array and add to selectedFiles
            const newFiles = Array.from(files);
            selectedFiles = [...selectedFiles, ...newFiles];
            
            // Show files list
            document.getElementById('files-list').classList.remove('hidden');
            
            // Update files count
            document.getElementById('files-count').textContent = `${selectedFiles.length} archivos`;
            
            // Render files list
            renderFilesList();
            
            // Procesar archivos para detectar orientaci√≥n
            processFilesForOrientation();
        }

        function renderFilesList() {
            const container = document.getElementById('files-container');
            container.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.id = `file-item-${index}`;
                
                // Determine file status
                let statusClass = 'file-status-pending';
                let statusText = 'Pendiente';
                
                if (file.status === 'uploading') {
                    statusClass = 'file-status-uploading';
                    statusText = 'Subiendo...';
                } else if (file.status === 'success') {
                    statusClass = 'file-status-success';
                    statusText = 'Completado';
                } else if (file.status === 'error') {
                    statusClass = 'file-status-error';
                    statusText = 'Error';
                } else if (file.status === 'orientation') {
                    statusClass = 'file-status-orientation';
                    statusText = 'Revisando orientaci√≥n';
                }
                
                // Format file size
                const fileSize = formatFileSize(file.size);
                
                fileItem.innerHTML = `
                    <div class="file-icon">üì∑</div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${fileSize}</div>
                        ${file.status === 'uploading' ? `
                            <div class="file-progress">
                                <div class="file-progress-bar" id="progress-${index}" style="width: ${file.progress || 0}%"></div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="file-status ${statusClass}">${statusText}</div>
                `;
                
                container.appendChild(fileItem);
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function clearFileList() {
            selectedFiles = [];
            filesNeedingCorrection = [];
            correctedFiles = {};
            document.getElementById('files-list').classList.add('hidden');
            document.getElementById('orientation-correction').classList.add('hidden');
            document.getElementById('file-input').value = '';
        }

        // Funciones para la correcci√≥n de orientaci√≥n
        async function processFilesForOrientation() {
            filesNeedingCorrection = [];
            correctedFiles = {};
            
            // Ocultar secci√≥n de correcci√≥n mientras procesamos
            document.getElementById('orientation-correction').classList.add('hidden');
            
            // Procesar cada archivo para detectar si necesita correcci√≥n
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                file.status = 'orientation';
                renderFilesList();
                
                try {
                    const needsCorrection = await checkImageOrientation(file);
                    if (needsCorrection) {
                        filesNeedingCorrection.push({
                            file: file,
                            index: i,
                            corrected: false
                        });
                    }
                } catch (error) {
                    console.error('Error checking orientation for', file.name, error);
                }
                
                file.status = 'pending';
                renderFilesList();
            }
            
            // Si hay archivos que necesitan correcci√≥n, mostrar la secci√≥n
            if (filesNeedingCorrection.length > 0) {
                showOrientationCorrection();
            }
        }

        async function checkImageOrientation(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = function() {
                    // Crear un canvas para analizar la imagen
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // Obtener los datos de la imagen
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // An√°lisis simple para detectar si la imagen podr√≠a estar rotada
                    // Buscamos patrones que sugieran que las caras est√°n en una orientaci√≥n no natural
                    
                    // M√©todo 1: Verificar la relaci√≥n de aspecto
                    const aspectRatio = canvas.width / canvas.height;
                    
                    // Si la imagen es muy ancha en comparaci√≥n con su altura, podr√≠a estar rotada
                    if (aspectRatio > 1.5) {
                        // Podr√≠a ser una imagen horizontal, pero si detectamos caras, verificamos su orientaci√≥n
                        // Este es un m√©todo simple, en un caso real usar√≠amos un modelo de ML m√°s sofisticado
                        resolve(true);
                        return;
                    }
                    
                    // M√©todo 2: An√°lisis de gradientes para detectar posibles caras en orientaci√≥n incorrecta
                    // Este es un m√©todo simplificado, en producci√≥n usar√≠amos una librer√≠a de detecci√≥n de caras
                    
                    // Por ahora, usaremos un enfoque basado en la detecci√≥n de caras del backend
                    // Simulamos que algunas im√°genes necesitan correcci√≥n para demostrar la funcionalidad
                    const randomCheck = Math.random();
                    if (randomCheck < 0.3) { // 30% de probabilidad de necesitar correcci√≥n para demostraci√≥n
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                };
                
                img.onerror = function() {
                    reject(new Error('Error loading image'));
                };
                
                // Cargar la imagen
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function showOrientationCorrection() {
            const orientationSection = document.getElementById('orientation-correction');
            const previewContainer = document.getElementById('orientation-preview');
            
            // Limpiar el contenedor de vista previa
            previewContainer.innerHTML = '';
            
            // Mostrar vista previa de las im√°genes que necesitan correcci√≥n
            filesNeedingCorrection.forEach((item, index) => {
                const file = item.file;
                const fileIndex = item.index;
                
                // Crear contenedor para la vista previa
                const imageContainer = document.createElement('div');
                imageContainer.className = 'orientation-image-container';
                
                // Crear etiqueta
                const label = document.createElement('div');
                label.className = 'orientation-label';
                label.textContent = file.name;
                imageContainer.appendChild(label);
                
                // Crear imagen original
                const originalContainer = document.createElement('div');
                originalContainer.className = 'orientation-image-container';
                
                const originalLabel = document.createElement('div');
                originalLabel.className = 'orientation-label';
                originalLabel.textContent = 'Original';
                originalContainer.appendChild(originalLabel);
                
                const originalImg = document.createElement('img');
                originalImg.className = 'orientation-image';
                originalImg.id = `original-${index}`;
                
                const originalBadge = document.createElement('div');
                originalBadge.className = 'orientation-badge';
                originalBadge.textContent = 'Posible rotaci√≥n';
                
                originalContainer.appendChild(originalImg);
                originalContainer.appendChild(originalBadge);
                
                // Crear imagen corregida
                const correctedContainer = document.createElement('div');
                correctedContainer.className = 'orientation-image-container';
                
                const correctedLabel = document.createElement('div');
                correctedLabel.className = 'orientation-label';
                correctedLabel.textContent = 'Corregida';
                correctedContainer.appendChild(correctedLabel);
                
                const correctedImg = document.createElement('img');
                correctedImg.className = 'orientation-image';
                correctedImg.id = `corrected-${index}`;
                
                const correctedBadge = document.createElement('div');
                correctedBadge.className = 'orientation-badge';
                correctedBadge.textContent = 'Orientaci√≥n corregida';
                correctedBadge.style.backgroundColor = '#10b981';
                
                correctedContainer.appendChild(correctedImg);
                correctedContainer.appendChild(correctedBadge);
                
                // A√±adir contenedores al contenedor principal
                imageContainer.appendChild(originalContainer);
                imageContainer.appendChild(correctedContainer);
                previewContainer.appendChild(imageContainer);
                
                // Cargar im√°genes
                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImg.src = e.target.result;
                    
                    // Crear una versi√≥n rotada de la imagen para la vista previa
                    const rotatedCanvas = document.createElement('canvas');
                    const rotatedCtx = rotatedCanvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = function() {
                        // Determinar la rotaci√≥n necesaria (90 grados en sentido horario para este ejemplo)
                        const angle = 90 * Math.PI / 180;
                        
                        // Calcular nuevas dimensiones despu√©s de la rotaci√≥n
                        const sin = Math.abs(Math.sin(angle));
                        const cos = Math.abs(Math.cos(angle));
                        
                        rotatedCanvas.width = img.height * sin + img.width * cos;
                        rotatedCanvas.height = img.height * cos + img.width * sin;
                        
                        // Aplicar rotaci√≥n
                        rotatedCtx.translate(rotatedCanvas.width / 2, rotatedCanvas.height / 2);
                        rotatedCtx.rotate(angle);
                        rotatedCtx.drawImage(img, -img.width / 2, -img.height / 2);
                        
                        // Convertir el canvas a URL de datos
                        correctedImg.src = rotatedCanvas.toDataURL('image/jpeg', 0.9);
                        
                        // Guardar la imagen corregida para uso posterior
                        rotatedCanvas.toBlob(function(blob) {
                            correctedFiles[fileIndex] = blob;
                        }, 'image/jpeg', 0.9);
                    };
                    
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
            
            // Mostrar la secci√≥n de correcci√≥n
            orientationSection.classList.remove('hidden');
        }

        function applyOrientationCorrection() {
            // Aplicar las correcciones a los archivos
            filesNeedingCorrection.forEach(item => {
                const index = item.index;
                if (correctedFiles[index]) {
                    // Reemplazar el archivo original con el corregido
                    const correctedBlob = correctedFiles[index];
                    const originalFile = selectedFiles[index];
                    
                    // Crear un nuevo archivo con la imagen corregida
                    const correctedFile = new File(
                        [correctedBlob], 
                        originalFile.name, 
                        { type: 'image/jpeg' }
                    );
                    
                    // Mantener las propiedades del archivo original
                    correctedFile.status = originalFile.status;
                    correctedFile.progress = originalFile.progress;
                    
                    // Reemplazar en la lista
                    selectedFiles[index] = correctedFile;
                    item.corrected = true;
                }
            });
            
            // Ocultar la secci√≥n de correcci√≥n
            document.getElementById('orientation-correction').classList.add('hidden');
            
            // Actualizar la lista de archivos
            renderFilesList();
            
            // Mostrar notificaci√≥n
            alert(`Se han corregido ${filesNeedingCorrection.length} im√°genes. Ahora puedes subirlas.`);
        }

        function skipOrientationCorrection() {
            // Ocultar la secci√≥n de correcci√≥n sin aplicar cambios
            document.getElementById('orientation-correction').classList.add('hidden');
            
            // Marcar los archivos como que no necesitan correcci√≥n
            filesNeedingCorrection.forEach(item => {
                item.corrected = false;
            });
        }

        async function uploadAllFiles() {
            if (selectedFiles.length === 0 || isUploading) return;
            
            isUploading = true;
            currentUploadIndex = 0;
            totalUploadsCompleted = 0;
            totalUploadsFailed = 0;
            
            // Update UI
            document.getElementById('upload-prompt').classList.add('hidden');
            document.getElementById('upload-status').classList.remove('hidden');
            document.getElementById('upload-area').classList.add('uploading');
            
            // Initialize all files as pending
            selectedFiles.forEach(file => {
                file.status = 'pending';
                file.progress = 0;
            });
            
            renderFilesList();
            
            // Process files one by one
            await processUploadQueue();
            
            // Final summary
            isUploading = false;
            document.getElementById('upload-prompt').classList.remove('hidden');
            document.getElementById('upload-status').classList.add('hidden');
            document.getElementById('upload-area').classList.remove('uploading');
            
            // Show summary
            alert(`Proceso completado:\n${totalUploadsCompleted} archivos subidos con √©xito\n${totalUploadsFailed} archivos con errores`);
            
            // Refresh data
            fetchPhotos();
            fetchStats();
            
            // Clear the list after successful upload
            if (totalUploadsCompleted > 0) {
                clearFileList();
            }
        }

        async function processUploadQueue() {
            while (currentUploadIndex < selectedFiles.length) {
                const file = selectedFiles[currentUploadIndex];
                
                // Update file status to uploading
                file.status = 'uploading';
                file.progress = 0;
                renderFilesList();
                
                try {
                    await uploadSingleFile(file, currentUploadIndex);
                    totalUploadsCompleted++;
                } catch (error) {
                    console.error(`Error uploading ${file.name}:`, error);
                    file.status = 'error';
                    totalUploadsFailed++;
                }
                
                currentUploadIndex++;
            }
        }

        async function uploadSingleFile(file, index) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                
                const xhr = new XMLHttpRequest();
                
                // Update progress
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        file.progress = percentComplete;
                        
                        // Update progress bar
                        const progressBar = document.getElementById(`progress-${index}`);
                        if (progressBar) {
                            progressBar.style.width = `${percentComplete}%`;
                        }
                    }
                });
                
                // Handle response
                xhr.addEventListener('load', () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                file.status = 'success';
                                file.facesDetected = response.faces_detected;
                                resolve(response);
                            } else {
                                file.status = 'error';
                                file.errorMessage = response.detail || 'Error desconocido';
                                reject(new Error(file.errorMessage));
                            }
                        } catch (e) {
                            file.status = 'error';
                            file.errorMessage = 'Error parsing response';
                            reject(new Error(file.errorMessage));
                        }
                    } else {
                        file.status = 'error';
                        file.errorMessage = `HTTP ${xhr.status}`;
                        reject(new Error(file.errorMessage));
                    }
                    
                    renderFilesList();
                });
                
                // Handle errors
                xhr.addEventListener('error', () => {
                    file.status = 'error';
                    file.errorMessage = 'Network error';
                    renderFilesList();
                    reject(new Error(file.errorMessage));
                });
                
                // Send request
                xhr.open('POST', `${API}/upload-photo`, true);
                xhr.send(formData);
            });
        }

        // Webcam functions
        async function toggleWebcam() {
            const webcamSection = document.getElementById('webcam-section');
            const webcamBtn = document.getElementById('webcam-btn');
            const webcamVideo = document.getElementById('webcam');
            const webcamPlaceholder = document.getElementById('webcam-placeholder');

            if (!showWebcam) {
                try {
                    webcamStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'user' } 
                    });
                    webcamVideo.srcObject = webcamStream;
                    webcamVideo.classList.remove('hidden');
                    webcamPlaceholder.classList.add('hidden');
                    webcamSection.classList.remove('hidden');
                    webcamBtn.textContent = 'üì∑ Cerrar C√°mara';
                    showWebcam = true;
                } catch (error) {
                    console.error('Error accessing webcam:', error);
                    alert('Error accediendo a la c√°mara: ' + error.message);
                }
            } else {
                if (webcamStream) {
                    webcamStream.getTracks().forEach(track => track.stop());
                    webcamStream = null;
                }
                webcamVideo.srcObject = null;
                webcamVideo.classList.add('hidden');
                webcamPlaceholder.classList.remove('hidden');
                webcamSection.classList.add('hidden');
                webcamBtn.textContent = 'üì∑ Usar C√°mara Web';
                showWebcam = false;
            }
        }

        async function capturePhoto() {
            if (isSearching || !webcamStream) return;

            const webcamVideo = document.getElementById('webcam');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = webcamVideo.videoWidth;
            canvas.height = webcamVideo.videoHeight;
            ctx.drawImage(webcamVideo, 0, 0);

            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('file', blob, 'webcam-capture.jpg');
                await performSearch(formData);
            }, 'image/jpeg', 0.8);
        }

        // Search functions
        async function searchWithFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            await performSearch(formData);
            event.target.value = '';
        }

        async function performSearch(formData) {
            isSearching = true;
            const captureBtn = document.getElementById('capture-btn');
            if (captureBtn) {
                captureBtn.textContent = 'Buscando...';
                captureBtn.disabled = true;
            }

            try {
                console.log('Searching faces at:', API + '/search-face?threshold=' + searchThreshold);
                const response = await fetch(API + '/search-face?threshold=' + searchThreshold, {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response body:', errorText);
                    throw new Error('HTTP ' + response.status + ': ' + (errorText || 'Error desconocido'));
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const responseText = await response.text();
                    console.error('Non-JSON response:', responseText.substring(0, 200));
                    throw new Error('El servidor no devolvi√≥ JSON. Posible error 404 o problema en el endpoint.');
                }

                const data = await response.json();
                console.log('Search response:', data);

                if (data.success) {
                    searchResults = data.matches || [];
                    
                    if (data.matches_found > 0) {
                        const matchedPhotoIds = [...new Set(data.matches.map(match => match.photo_id))];
                        filteredPhotos = uploadedPhotos.filter(photo => matchedPhotoIds.includes(photo.id));
                        isSearchMode = true;
                        switchTab('gallery');
                        
                        alert('Encontr√© ' + data.matches_found + ' coincidencias en ' + filteredPhotos.length + ' fotos!');
                    } else {
                        filteredPhotos = [];
                        isSearchMode = false;
                        alert('No se encontraron coincidencias con el umbral actual.');
                    }
                    
                    renderPhotos();
                    renderResults();
                } else {
                    alert('Error en la b√∫squeda: ' + (data.detail || data.message || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Search error:', error);
                if (error.message.includes('<!DOCTYPE')) {
                    alert('Error: El servidor devolvi√≥ HTML en lugar de JSON. Verifica que el endpoint /api/search-face existe en tu backend.');
                } else {
                    alert('Error buscando la cara: ' + error.message);
                }
            } finally {
                isSearching = false;
                if (captureBtn) {
                    captureBtn.textContent = 'Capturar y Buscar';
                    captureBtn.disabled = false;
                }
                if (showWebcam) {
                    toggleWebcam(); // Close webcam after search
                }
            }
        }

        function clearSearchFilter() {
            isSearchMode = false;
            filteredPhotos = [];
            searchResults = [];
            renderPhotos();
        }

        // Photo deletion
        async function deletePhoto(photoId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta foto?')) return;

            try {
                const response = await fetch(`${API}/photos/${photoId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Foto eliminada correctamente');
                    await fetchPhotos();
                    await fetchStats();
                } else {
                    alert('Error eliminando la foto: ' + (data.detail || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error eliminando la foto: ' + error.message);
            }
        }

        // Rendering functions
        function renderPhotos() {
            const container = document.getElementById('photos-container');
            const photosToShow = isSearchMode ? filteredPhotos : uploadedPhotos;
            
            // Update gallery header
            const galleryTitle = document.getElementById('gallery-title');
            const gallerySubtitle = document.getElementById('gallery-subtitle');
            const searchModeIndicator = document.getElementById('search-mode-indicator');
            const clearSearchBtn = document.getElementById('clear-search-btn');

            if (isSearchMode) {
                galleryTitle.textContent = 'Fotos con Coincidencias';
                gallerySubtitle.textContent = filteredPhotos.length + ' fotos con coincidencias de b√∫squeda';
                searchModeIndicator.classList.remove('hidden');
                clearSearchBtn.classList.remove('hidden');
            } else {
                galleryTitle.textContent = 'Galer√≠a de Fotos';
                gallerySubtitle.textContent = uploadedPhotos.length + ' fotos en total';
                searchModeIndicator.classList.add('hidden');
                clearSearchBtn.classList.add('hidden');
            }

            if (photosToShow.length === 0) {
                const emptyTitle = isSearchMode ? 'No hay coincidencias' : 'No hay fotos a√∫n';
                const emptySubtitle = isSearchMode 
                    ? 'Intenta ajustar el umbral de b√∫squeda o busca otra persona'
                    : '¬°Sube algunas fotos para comenzar!';

                container.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-icon">üñºÔ∏è</div>' +
                    '<h3 class="empty-title">' + emptyTitle + '</h3>' +
                    '<p class="empty-subtitle">' + emptySubtitle + '</p>' +
                    (isSearchMode ? 
                        '<div class="empty-actions">' +
                            '<button class="btn btn-primary" onclick="switchTab(\'search\')">' +
                                'Nueva B√∫squeda' +
                            '</button>' +
                            '<button class="btn btn-ghost" onclick="clearSearchFilter()">' +
                                'Ver Todas las Fotos' +
                            '</button>' +
                        '</div>' : '') +
                    '</div>';
                return;
            }

            const photosGrid = document.createElement('div');
            photosGrid.className = 'photos-grid';

            photosToShow.forEach(photo => {
                let matchInfo = null;
                if (isSearchMode && searchResults.length > 0) {
                    const photoMatches = searchResults.filter(match => match.photo_id === photo.id);
                    if (photoMatches.length > 0) {
                        const bestMatch = photoMatches.reduce((best, current) => 
                            current.similarity > best.similarity ? current : best
                        );
                        matchInfo = {
                            count: photoMatches.length,
                            bestSimilarity: bestMatch.similarity
                        };
                    }
                }

                const photoCard = document.createElement('div');
                photoCard.className = 'photo-card' + (isSearchMode ? ' photo-card-match' : '');
                photoCard.onclick = () => openPhotoPopup(photo.id);

                const matchBadge = isSearchMode && matchInfo ? 
                    '<div class="match-badge">üéØ ' + Math.round(matchInfo.bestSimilarity * 100) + '%</div>' : '';
                
                const matchInfoText = isSearchMode && matchInfo ? 
                    '<p class="match-info">' + matchInfo.count + ' coincidencia' + (matchInfo.count > 1 ? 's' : '') + '</p>' : '';

                photoCard.innerHTML = '<div class="photo-image">' +
                        '<img src="' + API + '/image/photo/' + photo.id + '" alt="' + photo.filename + '" ' +
                             'onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">' +
                        '<div class="photo-placeholder" style="display: none;">üñºÔ∏è</div>' +
                        '<div class="photo-badge">' + photo.faces_count + ' caras</div>' +
                        matchBadge +
                    '</div>' +
                    '<div class="photo-info">' +
                        '<h4 class="photo-title">' + photo.filename + '</h4>' +
                        '<p class="photo-date">' + new Date(photo.upload_date).toLocaleDateString() + '</p>' +
                        matchInfoText +
                        '<div class="photo-actions">' +
                            '<button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deletePhoto(\'' + photo.id + '\')">' +
                                'üóëÔ∏è Eliminar' +
                            '</button>' +
                        '</div>' +
                    '</div>';

                photosGrid.appendChild(photoCard);
            });

            container.innerHTML = '';
            container.appendChild(photosGrid);
        }

        function renderResults() {
            const container = document.getElementById('results-container');

            if (searchResults.length === 0) {
                container.innerHTML = '<div class="empty-state">' +
                        '<div class="empty-icon">üéØ</div>' +
                        '<h3 class="empty-title">No hay resultados a√∫n</h3>' +
                        '<p class="empty-subtitle">Usa la funci√≥n de b√∫squeda para encontrar coincidencias</p>' +
                        '<button class="btn btn-primary" onclick="switchTab(\'search\')">' +
                            'Comenzar B√∫squeda' +
                        '</button>' +
                    '</div>';
                return;
            }

            let resultsHTML = '<div class="results-section">' +
                '<div class="results-header">' +
                    '<div class="results-info">' +
                        '<h3 class="results-title">Resultados de B√∫squeda</h3>' +
                        '<p class="results-subtitle">' + searchResults.length + ' coincidencias encontradas</p>' +
                    '</div>' +
                    '<button class="btn btn-ghost" onclick="clearResults()">' +
                        'Limpiar resultados' +
                    '</button>' +
                '</div>' +
                '<div class="results-grid">';

            searchResults.forEach((result, index) => {
                resultsHTML += '<div class="result-card" onclick="openPhotoPopupFromResult(\'' + result.photo_id + '\')">' +
                        '<div class="result-image">' +
                            '<img src="' + API + '/image/photo/' + result.photo_id + '" alt="' + result.photo_filename + '"' +
                                 ' onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">' +
                            '<div class="result-placeholder" style="display: none;">üñºÔ∏è</div>' +
                            '<div class="result-rank">#' + (index + 1) + '</div>' +
                            '<div class="result-similarity">' + Math.round(result.similarity * 100) + '%</div>' +
                        '</div>' +
                        '<div class="result-info">' +
                            '<h4 class="result-title">' + result.photo_filename + '</h4>' +
                            '<p class="result-score">Similitud: ' + Math.round(result.similarity * 100) + '%</p>' +
                            '<p class="result-id">ID: ' + result.face_id.slice(0, 8) + '...</p>' +
                        '</div>' +
                    '</div>';
            });

            resultsHTML += '</div></div>';
            container.innerHTML = resultsHTML;
        }

        // CORRECCI√ìN: Funci√≥n renderClients corregida para usar el nuevo endpoint
        function renderClients() {
            const container = document.getElementById('clients-container');
            
            if (searchedClients.length === 0) {
                container.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-icon">üë•</div>' +
                    '<h3 class="empty-title">No hay clientes a√∫n</h3>' +
                    '<p class="empty-subtitle">Los clientes que busquen sus fotos aparecer√°n aqu√≠</p>' +
                    '</div>';
                return;
            }

            const clientsGrid = document.createElement('div');
            clientsGrid.className = 'clients-grid';

            searchedClients.forEach(client => {
                const clientCard = document.createElement('div');
                clientCard.className = 'client-card';

                // CORRECCI√ìN: Construir URL sin agregar /faces/ extra
                // El endpoint es /faces/{filename} donde filename puede ser UUID o UUID.jpg
                const faceImageUrl = client.face_image_path ? 
                    `${BACKEND_URL}/faces/${client.face_image_path}` : null;
                
                console.log('Cliente:', client);
                console.log('face_image_path:', client.face_image_path);
                console.log('URL construida:', faceImageUrl);

                const matchInfo = client.best_match_photo_id ? 
                    '<div class="client-match">' +
                        '<div class="client-match-info">Mejor coincidencia:</div>' +
                        '<div>' + (client.best_match_filename || 'Desconocido') + '</div>' +
                    '</div>' +
                    '<div class="client-similarity">' +
                        'Similitud: <span class="client-similarity-value">' + 
                        (client.best_match_similarity ? Math.round(client.best_match_similarity * 100) + '%' : 'N/A') + 
                        '</span>' +
                    '</div>' : 
                    '<div class="client-match">' +
                        '<div class="client-match-info">Sin coincidencias</div>' +
                    '</div>';

                clientCard.innerHTML = '<div class="client-header">' +
                        '<div class="client-phone">' + client.phone_number + '</div>' +
                        '<div class="client-date">' + new Date(client.search_date).toLocaleDateString() + '</div>' +
                    '</div>' +
                    '<div class="client-content">' +
                        '<div class="client-image">' +
                            (faceImageUrl ? 
                                '<img src="' + faceImageUrl + '" alt="Cara del cliente" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">' +
                                '<div class="client-image-placeholder" style="display: none;">üë§</div>' :
                                '<div class="client-image-placeholder">üë§</div>'
                            ) +
                        '</div>' +
                        '<div class="client-info">' +
                            matchInfo +
                        '</div>' +
                    '</div>';

                clientsGrid.appendChild(clientCard);
            });

            container.innerHTML = '';
            container.appendChild(clientsGrid);
        }

        function clearResults() {
            searchResults = [];
            renderResults();
        }

        function refreshClients() {
            fetchSearchedClients();
        }

        // Photo popup functions
        function openPhotoPopup(photoId) {
            const photo = uploadedPhotos.find(p => p.id === photoId);
            if (!photo) return;

            selectedPhoto = photo;
            
            document.getElementById('popup-filename').textContent = photo.filename;
            document.getElementById('popup-date').textContent = new Date(photo.upload_date).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('popup-faces-count').textContent = photo.faces_count;
            document.getElementById('popup-file-size').textContent = photo.file_size ? 
                Math.round(photo.file_size / 1024) + ' KB' : 'N/A';
            document.getElementById('popup-photo-id').textContent = photo.id;

            const popupImage = document.getElementById('popup-image');
            const popupPlaceholder = document.getElementById('popup-placeholder');
            
            popupImage.src = API + '/image/photo/' + photo.id;
            popupImage.style.display = 'block';
            popupPlaceholder.classList.add('hidden');
            
            popupImage.onerror = function() {
                this.style.display = 'none';
                popupPlaceholder.classList.remove('hidden');
            };

            const description = 'Esta foto contiene ' + photo.faces_count + ' ' + (photo.faces_count === 1 ? 'cara detectada' : 'caras detectadas') + '. Puedes imprimir esta imagen en formato A5 optimizado para una mejor calidad de impresi√≥n.';
            document.getElementById('popup-description').textContent = description;

            document.getElementById('photo-popup-overlay').classList.remove('hidden');
        }

        function openPhotoPopupFromResult(photoId) {
            openPhotoPopup(photoId);
        }

        function closePhotoPopup() {
            document.getElementById('photo-popup-overlay').classList.add('hidden');
            selectedPhoto = null;
        }

        function printPhoto() {
            if (!selectedPhoto) return;

            const printWindow = window.open('', '_blank');
            const imageUrl = API + '/image/photo/' + selectedPhoto.id;
            
            printWindow.document.write('<!DOCTYPE html>' +
                '<html>' +
                    '<head>' +
                        '<title>Imprimir Foto - ' + selectedPhoto.filename + '</title>' +
                        '<style>' +
                            '@page {' +
                                'size: A5;' +
                                'margin: 0;' +
                            '}' +
                            'body {' +
                                'margin: 0;' +
                                'padding: 0;' +
                                'display: flex;' +
                                'justify-content: center;' +
                                'align-items: center;' +
                                'height: 100vh;' +
                                'background: white;' +
                            '}' +
                            '.print-container {' +
                                'width: 148mm;' +
                                'height: 210mm;' +
                                'display: flex;' +
                                'justify-content: center;' +
                                'align-items: center;' +
                                'padding: 10mm;' +
                                'box-sizing: border-box;' +
                            '}' +
                            '.print-image {' +
                                'max-width: 100%;' +
                                'max-height: 100%;' +
                                'object-fit: contain;' +
                                'box-shadow: 0 2px 10px rgba(0,0,0,0.1);' +
                            '}' +
                            '@media print {' +
                                'body {' +
                                    'print-color-adjust: exact;' +
                                    '-webkit-print-color-adjust: exact;' +
                                '}' +
                            '}' +
                        '</style>' +
                    '</head>' +
                    '<body>' +
                        '<div class="print-container">' +
                            '<img src="' + imageUrl + '" alt="' + selectedPhoto.filename + '" class="print-image" onload="window.focus(); window.print(); window.close();" />' +
                        '</div>' +
                    '</body>' +
                '</html>');
            
            printWindow.document.close();
        }

        // Clean up webcam when page is unloaded
        window.addEventListener('beforeunload', function() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
