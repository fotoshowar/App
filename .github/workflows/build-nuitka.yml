name: Build Windows Executable with Nuitka

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        shell: cmd
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka
      
      - name: Create models directory
        shell: cmd
        run: mkdir models
      
      - name: Install and copy models
        shell: cmd
        run: |
          pip install face_recognition_models
          python -c "import face_recognition_models; import os; import shutil; models_source_path = os.path.join(os.path.dirname(face_recognition_models.__file__), 'models'); [shutil.copy2(os.path.join(models_source_path, f), os.path.join('models', f)) for f in os.listdir(models_source_path) if f.endswith('.dat')]"
      
      - name: Download additional models
        shell: cmd
        run: |
          if not exist "models\shape_predictor_68_face_landmarks.dat" powershell -Command "Invoke-WebRequest -Uri 'https://github.com/davisking/dlib-models/raw/master/shape_predictor_68_face_landmarks.dat.bz2' -OutFile 'models\shape_predictor_68_face_landmarks.dat.bz2'" && powershell -Command "Add-Type -AssemblyName System.IO.Compression.FileSystem; [System.IO.Compression.ZipFile]::ExtractToDirectory('models\shape_predictor_68_face_landmarks.dat.bz2', 'models')" && del "models\shape_predictor_68_face_landmarks.dat.bz2"
          if not exist "models\dlib_face_recognition_resnet_model_v1.dat" powershell -Command "Invoke-WebRequest -Uri 'https://github.com/davisking/dlib-models/raw/master/dlib_face_recognition_resnet_model_v1.dat.bz2' -OutFile 'models\dlib_face_recognition_resnet_model_v1.dat.bz2'" && powershell -Command "Add-Type -AssemblyName System.IO.Compression.FileSystem; [System.IO.Compression.ZipFile]::ExtractToDirectory('models\dlib_face_recognition_resnet_model_v1.dat.bz2', 'models')" && del "models\dlib_face_recognition_resnet_model_v1.dat.bz2"
      
      - name: Verify models
        shell: cmd
        run: python verify_models.py --models-dir models --test-system
      
      - name: Build with Nuitka
        shell: cmd
        run: |
          python -m nuitka --standalone --onefile --include-data-dir=models=models --include-data-dir=static=static --output-filename=fotoshow.exe --enable-plugin=numpy --enable-plugin=torch --enable-plugin=cv2 --enable-plugin=PIL --windows-disable-console --follow-imports --show-progress --show-memory main.py
      
      - name: Create package
        shell: cmd
        run: |
          mkdir fotoshow-windows-nuitka
          copy fotoshow.exe fotoshow-windows-nuitka\
          if exist static xcopy /E /I /Y static fotoshow-windows-nuitka\static\
          if exist models xcopy /E /I /Y models fotoshow-windows-nuitka\models\
          echo @echo off > fotoshow-windows-nuitka\run.bat
          echo title FOTOSHOW >> fotoshow-windows-nuitka\run.bat
          echo echo Starting application... >> fotoshow-windows-nuitka\run.bat
          echo fotoshow.exe >> fotoshow-windows-nuitka\run.bat
          echo if errorlevel 1 pause >> fotoshow-windows-nuitka\run.bat
          powershell -Command "Compress-Archive -Path 'fotoshow-windows-nuitka\*' -DestinationPath 'fotoshow-windows-nuitka.zip' -Force"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-nuitka-package
          path: fotoshow-windows-nuitka.zip
