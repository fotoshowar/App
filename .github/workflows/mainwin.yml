name: Build Windows Executable

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Te permite ejecutarlo manualmente

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Clean and create models directory
        shell: cmd
        run: |
          echo Preparing models directory...
          if exist models (
              echo Removing existing models directory...
              rmdir /s /q models
          )
          echo Creating local models directory...
          mkdir models

      - name: Install face_recognition_models and copy dlib models
        shell: cmd
        run: |
          echo Installing face_recognition_models to get the files...
          pip install face_recognition_models
          
          echo Searching and copying dlib models...
          set PYTHONIOENCODING=utf-8
          python -c "import face_recognition_models; import os; import shutil; models_source_path = os.path.join(os.path.dirname(face_recognition_models.__file__), 'models'); print('Models source:', models_source_path); [shutil.copy2(os.path.join(models_source_path, f), os.path.join('models', f)) for f in os.listdir(models_source_path) if f.endswith('.dat')]; print('Models copied successfully')"
          
          echo Verifying copied models:
          dir models

      - name: Download additional models if needed
        shell: cmd
        run: |
          echo Verifying and downloading additional models if needed...
          
          if not exist "models\shape_predictor_68_face_landmarks.dat" (
              echo Downloading shape_predictor_68_face_landmarks.dat...
              powershell -Command "Invoke-WebRequest -Uri 'https://github.com/davisking/dlib-models/raw/master/shape_predictor_68_face_landmarks.dat.bz2' -OutFile 'models\shape_predictor_68_face_landmarks.dat.bz2'"
              powershell -Command "Add-Type -AssemblyName System.IO.Compression.FileSystem; [System.IO.Compression.ZipFile]::ExtractToDirectory('models\shape_predictor_68_face_landmarks.dat.bz2', 'models')"
              del "models\shape_predictor_68_face_landmarks.dat.bz2"
              echo shape_predictor_68_face_landmarks.dat downloaded
          ) else (
              echo shape_predictor_68_face_landmarks.dat already exists
          )
          
          if not exist "models\dlib_face_recognition_resnet_model_v1.dat" (
              echo Downloading dlib_face_recognition_resnet_model_v1.dat...
              powershell -Command "Invoke-WebRequest -Uri 'https://github.com/davisking/dlib-models/raw/master/dlib_face_recognition_resnet_model_v1.dat.bz2' -OutFile 'models\dlib_face_recognition_resnet_model_v1.dat.bz2'"
              powershell -Command "Add-Type -AssemblyName System.IO.Compression.FileSystem; [System.IO.Compression.ZipFile]::ExtractToDirectory('models\dlib_face_recognition_resnet_model_v1.dat.bz2', 'models')"
              del "models\dlib_face_recognition_resnet_model_v1.dat.bz2"
              echo dlib_face_recognition_resnet_model_v1.dat downloaded
          ) else (
              echo dlib_face_recognition_resnet_model_v1.dat already exists
          )
          
          echo Final models list:
          dir models

      - name: Install dependencies
        shell: cmd
        run: |
          echo Installing project dependencies...
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Create PyInstaller spec file
        shell: cmd
        run: |
          echo Creating PyInstaller spec file...
          (
          echo # -*- mode: python ; coding: utf-8 -*-
          echo.
          echo block_cipher = None
          echo.
          echo a = Analysis^(
          echo     ['main.py'],
          echo     pathex=[],
          echo     binaries=[],
          echo     datas=[
          echo         ^('models', 'models'^),
          echo         ^('static', 'static'^),
          echo     ],
          echo     hiddenimports=[
          echo         'face_recognition_models',
          echo         'dlib',
          echo         'cv2',
          echo         'numpy',
          echo         'torch',
          echo         'torchvision',
          echo         'facenet_pytorch',
          echo         'insightface',
          echo         'scipy',
          echo         'sklearn',
          echo         'PIL',
          echo         'cryptography',
          echo         'hkdf',
          echo         'aiosqlite',
          echo         'chromadb',
          echo         'httpx',
          echo         'fastapi',
          echo         'uvicorn',
          echo         'torch.nn',
          echo         'torch.optim',
          echo         'torch.utils.data',
          echo         'torch.backends.cudnn',
          echo         'torch.autograd',
          echo         'torch.serialization',
          echo         'onnxruntime',
          echo         'onnx',
          echo         'yaml',
          echo         'tqdm',
          echo         'requests',
          echo         'PIL._imagingtk',
          echo         'PIL._tkinter_finder',
          echo         'pkg_resources.py2_warn',
          echo         'matplotlib.backends.backend_tkagg',
          echo     ],
          echo     hookspath=[],
          echo     hooksconfig={},
          echo     runtime_hooks=[],
          echo     excludes=[],
          echo     win_no_prefer_redirects=False,
          echo     win_private_assemblies=False,
          echo     cipher=block_cipher,
          echo     noarchive=False,
          echo ^)
          echo.
          echo pyz = PYZ^(a.pure, a.zipped_data, cipher=block_cipher^)
          echo.
          echo exe = EXE^(
          echo     pyz,
          echo     a.scripts,
          echo     a.binaries,
          echo     a.zipfiles,
          echo     a.datas,
          echo     [],
          echo     name='main',
          echo     debug=False,
          echo     bootloader_ignore_signals=False,
          echo     strip=False,
          echo     upx=True,
          echo     upx_exclude=[],
          echo     runtime_tmpdir=None,
          echo     console=True,
          echo     disable_windowed_traceback=False,
          echo     argv_emulation=False,
          echo     target_arch=None,
          echo     codesign_identity=None,
          echo     entitlements_file=None,
          echo ^)
          ) > main.spec

      - name: Verify spec file
        shell: cmd
        run: |
          echo Verifying spec file:
          findstr "datas" main.spec

      - name: Build executable with PyInstaller
        shell: cmd
        run: |
          echo Building executable with PyInstaller...
          pyinstaller main.spec

      - name: Verify executable and included files
        shell: cmd
        run: |
          echo Verifying created executable:
          if exist "dist\main.exe" (
              echo main.exe found
              dir "dist\main.exe"
              
              echo Verifying dist directory structure:
              dir /s dist
          ) else (
              echo main.exe not found
              exit 1
          )

      - name: Create final package directory
        shell: cmd
        run: |
          echo Creating final package...
          mkdir fotoshow-windows
          
          REM Copy executable
          copy "dist\main.exe" "fotoshow-windows\"
          
          REM Copy static files if they exist
          if exist "static" (
              echo Copying static files...
              xcopy /E /I /Y "static" "fotoshow-windows\static"
          )
          
          REM Copy models
          echo Copying models...
          xcopy /E /I /Y "models" "fotoshow-windows\models"
          
          REM Create execution script
          (
          echo @echo off
          echo title FOTOSHOW - Facial Recognition System
          echo.
          echo =======================================
          echo       FOTOSHOW
          echo   Facial Recognition System
          echo =======================================
          echo.
          echo Starting application...
          echo.
          echo main.exe
          echo if errorlevel 1 ^(
          echo     echo.
          echo     Error executing the application.
          echo     pause
          echo     exit /b 1
          echo ^)
          ) > "fotoshow-windows\run.bat"
          
          REM Create README
          (
          echo # FOTOSHOW - Windows Package
          echo.
          echo ## Execution Instructions
          echo.
          echo ### Option 1: Automatic Execution ^(Recommended^)
          echo 1. Double-click on 'run.bat' file
          echo 2. Wait for the application to start
          echo.
          echo ### Option 2: Manual Execution
          echo 1. Open a terminal ^(CMD or PowerShell^)
          echo 2. Navigate to the directory where you extracted the package
          echo 3. Execute: 'main.exe'
          echo.
          echo ## Included Files
          echo - 'main.exe': Main application executable
          echo - 'models/': Facial recognition models ^(dlib^)
          echo - 'static/': Web interface static files
          echo - 'run.bat': Automatic execution script
          echo.
          echo ## Important Notes
          echo - Make sure all files remain in their respective folders
          echo - Do not move or delete the 'models/' folder
          echo - The application needs internet access for some features
          echo.
          echo ## System Requirements
          echo - Windows 10 or higher
          echo - 4GB RAM or more ^(8GB recommended^)
          echo - Disk space: 500MB free
          echo - Web camera ^(optional, for capture function^)
          ) > "fotoshow-windows\README.md"
          
          echo Final package content:
          dir /s fotoshow-windows

      - name: Create ZIP package
        shell: cmd
        run: |
          echo Creating ZIP package...
          powershell -Command "Compress-Archive -Path 'fotoshow-windows\*' -DestinationPath 'fotoshow-windows.zip' -Force"
          echo ZIP package created: fotoshow-windows.zip

      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/main.exe

      - name: Upload complete package artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-package
          path: fotoshow-windows.zip

      - name: Upload package directory artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-package-dir
          path: fotoshow-windows/
