name: Build Windows Executable

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Te permite ejecutarlo manualmente

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Create PyInstaller spec file
        run: |
          echo "
          # -*- mode: python ; coding: utf-8 -*-
          
          block_cipher = None
          
          a = Analysis(
              ['main.py'],
              pathex=[],
              binaries=[],
              datas=[
                  ('models', 'models'),
                  ('venv/Lib/site-packages/face_recognition_models/models', 'face_recognition_models/models'),
              ],
              hiddenimports=[
                  'face_recognition_models',
                  'dlib',
                  'cv2',
                  'numpy',
                  'torch',
                  'torchvision',
                  'facenet_pytorch',
                  'insightface',
                  'scipy',
                  'sklearn',
                  'PIL',
                  'cryptography',
                  'hkdf',
                  'aiosqlite',
                  'chromadb',
                  'httpx',
                  'fastapi',
                  'uvicorn',
              ],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=block_cipher,
              noarchive=False,
          )
          
          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)
          
          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.zipfiles,
              a.datas,
              [],
              name='main',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              upx_exclude=[],
              runtime_tmpdir=None,
              console=True,
              disable_windowed_traceback=False,
              argv_emulation=False,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
          )
          " > main.spec

      - name: Build executable with PyInstaller
        run: |
          pyinstaller main.spec

      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/main.exe
