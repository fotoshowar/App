name: Build Windows Executable

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Te permite ejecutarlo manualmente

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Clean and create models directory
        run: |
          echo "üìÅ Preparando directorio de modelos..."
          if exist models (
              echo "üóëÔ∏è Eliminando directorio models existente..."
              rmdir /s /q models
          )
          echo "üìÅ Creando directorio de modelos local..."
          mkdir models

      - name: Install face_recognition_models and copy dlib models
        run: |
          echo "üì¶ Instalando face_recognition_models para obtener los archivos..."
          pip install face_recognition_models
          
          echo "üîç Buscando y copiando modelos de dlib..."
          python -c "
          import face_recognition_models
          import os
          import shutil
          
          # Obtener la ruta donde est√°n instalados los modelos
          models_source_path = os.path.join(os.path.dirname(face_recognition_models.__file__), 'models')
          print(f'Fuente de modelos: {models_source_path}')
          
          # Copiar modelos al directorio local
          if os.path.exists(models_source_path):
              copied_files = []
              for file in os.listdir(models_source_path):
                  if file.endswith('.dat'):
                      source_file = os.path.join(models_source_path, file)
                      dest_file = os.path.join('models', file)
                      print(f'Copiando {file} a models/')
                      shutil.copy2(source_file, dest_file)
                      copied_files.append(file)
              print(f'‚úÖ Modelos copiados: {copied_files}')
          else:
              print(f'‚ùå No se encontr√≥ el directorio: {models_source_path}')
          "
          
          echo "üìã Verificando modelos copiados:"
          dir models

      - name: Download additional models if needed
        run: |
          echo "üåê Verificando y descargando modelos adicionales si es necesario..."
          
          # Verificar shape_predictor_68_face_landmarks.dat
          if not exist "models\shape_predictor_68_face_landmarks.dat" (
              echo "‚¨áÔ∏è Descargando shape_predictor_68_face_landmarks.dat..."
              powershell -Command "Invoke-WebRequest -Uri 'https://github.com/davisking/dlib-models/raw/master/shape_predictor_68_face_landmarks.dat.bz2' -OutFile 'models\shape_predictor_68_face_landmarks.dat.bz2'"
              powershell -Command "Add-Type -AssemblyName System.IO.Compression.FileSystem; [System.IO.Compression.ZipFile]::ExtractToDirectory('models\shape_predictor_68_face_landmarks.dat.bz2', 'models')"
              del "models\shape_predictor_68_face_landmarks.dat.bz2"
              echo "‚úÖ shape_predictor_68_face_landmarks.dat descargado"
          ) else (
              echo "‚úÖ shape_predictor_68_face_landmarks.dat ya existe"
          )
          
          # Verificar dlib_face_recognition_resnet_model_v1.dat
          if not exist "models\dlib_face_recognition_resnet_model_v1.dat" (
              echo "‚¨áÔ∏è Descargando dlib_face_recognition_resnet_model_v1.dat..."
              powershell -Command "Invoke-WebRequest -Uri 'https://github.com/davisking/dlib-models/raw/master/dlib_face_recognition_resnet_model_v1.dat.bz2' -OutFile 'models\dlib_face_recognition_resnet_model_v1.dat.bz2'"
              powershell -Command "Add-Type -AssemblyName System.IO.Compression.FileSystem; [System.IO.Compression.ZipFile]::ExtractToDirectory('models\dlib_face_recognition_resnet_model_v1.dat.bz2', 'models')"
              del "models\dlib_face_recognition_resnet_model_v1.dat.bz2"
              echo "‚úÖ dlib_face_recognition_resnet_model_v1.dat descargado"
          ) else (
              echo "‚úÖ dlib_face_recognition_resnet_model_v1.dat ya existe"
          )
          
          echo "üìã Lista final de modelos:"
          dir models

      - name: Install dependencies
        run: |
          echo "üì¶ Instalando dependencias del proyecto..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Create PyInstaller spec file
        run: |
          echo @"
          # -*- mode: python ; coding: utf-8 -*-
          
          block_cipher = None
          
          a = Analysis(
              ['main.py'],
              pathex=[],
              binaries=[],
              datas=[
                  ('models', 'models'),
                  ('static', 'static'),
              ],
              hiddenimports=[
                  'face_recognition_models',
                  'dlib',
                  'cv2',
                  'numpy',
                  'torch',
                  'torchvision',
                  'facenet_pytorch',
                  'insightface',
                  'scipy',
                  'sklearn',
                  'PIL',
                  'cryptography',
                  'hkdf',
                  'aiosqlite',
                  'chromadb',
                  'httpx',
                  'fastapi',
                  'uvicorn',
                  'torch.nn',
                  'torch.optim',
                  'torch.utils.data',
                  'torch.backends.cudnn',
                  'torch.autograd',
                  'torch.serialization',
                  'onnxruntime',
                  'onnx',
                  'yaml',
                  'tqdm',
                  'requests',
                  'PIL._imagingtk',
                  'PIL._tkinter_finder',
                  'pkg_resources.py2_warn',
                  'matplotlib.backends.backend_tkagg',
              ],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=block_cipher,
              noarchive=False,
          )
          
          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)
          
          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.zipfiles,
              a.datas,
              [],
              name='main',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              upx_exclude=[],
              runtime_tmpdir=None,
              console=True,
              disable_windowed_traceback=False,
              argv_emulation=False,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
          )
          "@ > main.spec

      - name: Verify spec file
        run: |
          echo "üîç Verificando archivo de especificaci√≥n:"
          powershell -Command "Get-Content main.spec | Select-String 'datas' -Context 2"

      - name: Build executable with PyInstaller
        run: |
          echo "üî® Construyendo ejecutable con PyInstaller..."
          pyinstaller main.spec

      - name: Verify executable and included files
        run: |
          echo "‚úÖ Verificando ejecutable creado:"
          if exist "dist\main.exe" (
              echo "‚úÖ main.exe encontrado"
              Get-Item "dist\main.exe" | Select-Object Name, Length
            
              echo "üìÅ Verificando estructura del directorio dist:"
              dir dist /s
          ) else (
              echo "‚ùå main.exe no encontrado"
              exit 1
          )

      - name: Create final package directory
        run: |
          echo "üì¶ Creando paquete final..."
          mkdir fotoshow-windows
          
          # Copiar ejecutable
          copy "dist\main.exe" "fotoshow-windows\"
          
          # Copiar archivos est√°ticos si existen
          if exist "static" (
              echo "üìÅ Copiando archivos est√°ticos..."
              xcopy /E /I /Y "static" "fotoshow-windows\static"
          )
          
          # Copiar modelos
          echo "üìÅ Copiando modelos..."
          xcopy /E /I /Y "models" "fotoshow-windows\models"
          
          # Crear script de ejecuci√≥n
          echo "@echo off" > "fotoshow-windows\run.bat"
          echo "title FOTOSHOW - Sistema de Reconocimiento Facial" >> "fotoshow-windows\run.bat"
          echo "echo." >> "fotoshow-windows\run.bat"
          echo "echo =======================================" >> "fotoshow-windows\run.bat"
          echo "echo       FOTOSHOW" >> "fotoshow-windows\run.bat"
          echo "echo   Sistema de Reconocimiento Facial" >> "fotoshow-windows\run.bat"
          echo "echo =======================================" >> "fotoshow-windows\run.bat"
          echo "echo." >> "fotoshow-windows\run.bat"
          echo "echo Iniciando aplicacion..." >> "fotoshow-windows\run.bat"
          echo "echo." >> "fotoshow-windows\run.bat"
          echo "main.exe" >> "fotoshow-windows\run.bat"
          echo "if errorlevel 1 (" >> "fotoshow-windows\run.bat"
          echo "    echo." >> "fotoshow-windows\run.bat"
          echo "    echo Error al ejecutar la aplicacion." >> "fotoshow-windows\run.bat"
          echo "    pause" >> "fotoshow-windows\run.bat"
          echo "    exit /b 1" >> "fotoshow-windows\run.bat"
          echo ")" >> "fotoshow-windows\run.bat"
          
          # Crear README mejorado
          echo "# FOTOSHOW - Windows Package" > "fotoshow-windows\README.md"
          echo "" >> "fotoshow-windows\README.md"
          echo "## üöÄ Instrucciones de Ejecuci√≥n" >> "fotoshow-windows\README.md"
          echo "" >> "fotoshow-windows\README.md"
          echo "### Opci√≥n 1: Ejecuci√≥n Autom√°tica (Recomendada)" >> "fotoshow-windows\README.md"
          echo "1. Haz doble clic en el archivo 'run.bat'" >> "fotoshow-windows\README.md"
          echo "2. Espera a que la aplicaci√≥n se inicie" >> "fotoshow-windows\README.md"
          echo "" >> "fotoshow-windows\README.md"
          echo "### Opci√≥n 2: Ejecuci√≥n Manual" >> "fotoshow-windows\README.md"
          echo "1. Abre una terminal (CMD o PowerShell)" >> "fotoshow-windows\README.md"
          echo "2. Navega al directorio donde descomprimiste el paquete" >> "fotoshow-windows\README.md"
          echo "3. Ejecuta: 'main.exe'" >> "fotoshow-windows\README.md"
          echo "" >> "fotoshow-windows\README.md"
          echo "## üìÅ Archivos Incluidos" >> "fotoshow-windows\README.md"
          echo "- 'main.exe': Ejecutable principal de la aplicaci√≥n" >> "fotoshow-windows\README.md"
          echo "- 'models/': Modelos de reconocimiento facial (dlib)" >> "fotoshow-windows\README.md"
          echo "- 'static/': Archivos est√°ticos de la interfaz web" >> "fotoshow-windows\README.md"
          echo "- 'run.bat': Script de ejecuci√≥n autom√°tica" >> "fotoshow-windows\README.md"
          echo "" >> "fotoshow-windows\README.md"
          echo "## ‚ö†Ô∏è Notas Importantes" >> "fotoshow-windows\README.md"
          echo "- Aseg√∫rate de que todos los archivos permanezcan en sus carpetas respectivas" >> "fotoshow-windows\README.md"
          echo "- No muevas ni elimines la carpeta 'models/'" >> "fotoshow-windows\README.md"
          echo "- La aplicaci√≥n necesita acceso a internet para algunas funcionalidades" >> "fotoshow-windows\README.md"
          echo "" >> "fotoshow-windows\README.md"
          echo "## üîß Requisitos del Sistema" >> "fotoshow-windows\README.md"
          echo "- Windows 10 o superior" >> "fotoshow-windows\README.md"
          echo "- 4GB de RAM o m√°s (recomendado 8GB)" >> "fotoshow-windows\README.md"
          echo "- Espacio en disco: 500MB libres" >> "fotoshow-windows\README.md"
          echo "- C√°mara web (opcional, para funci√≥n de captura)" >> "fotoshow-windows\README.md"
          
          echo "üìã Contenido del paquete final:"
          dir "fotoshow-windows" /s

      - name: Create ZIP package
        run: |
          echo "üóúÔ∏è Creando paquete ZIP..."
          powershell -Command "Compress-Archive -Path 'fotoshow-windows\*' -DestinationPath 'fotoshow-windows.zip' -Force"
          echo "‚úÖ Paquete ZIP creado: fotoshow-windows.zip"

      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/main.exe

      - name: Upload complete package artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-package
          path: fotoshow-windows.zip

      - name: Upload package directory artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-package-dir
          path: fotoshow-windows/
