name: Build Ubuntu Executable

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Te permite ejecutarlo manualmente

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libopenblas-dev \
            liblapack-dev \
            libx11-dev \
            libgtk-3-dev \
            python3-dev \
            python3-pip \
            pkg-config \
            libavcodec-dev \
            libavformat-dev \
            libswscale-dev \
            libtbb-dev \
            libtbbmalloc-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libdc1394-dev \
            libv4l-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libglib2.0-dev \
            libatlas-base-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Clean and create models directory
        run: |
          echo "Preparing models directory..."
          if [ -d "models" ]; then
              echo "Removing existing models directory..."
              rm -rf models
          fi
          echo "Creating local models directory..."
          mkdir -p models

      - name: Install face_recognition_models and copy dlib models
        run: |
          echo "Installing face_recognition_models to get the files..."
          pip install face_recognition_models
          
          echo "Searching and copying dlib models..."
          python3 -c "
import face_recognition_models
import os
import shutil

# Get the path where models are installed
models_source_path = os.path.join(os.path.dirname(face_recognition_models.__file__), 'models')
print('Models source: {}'.format(models_source_path))

# Copy models to local directory
if os.path.exists(models_source_path):
    copied_files = []
    for file in os.listdir(models_source_path):
        if file.endswith('.dat'):
            source_file = os.path.join(models_source_path, file)
            dest_file = os.path.join('models', file)
            print('Copying {} to models/'.format(file))
            shutil.copy2(source_file, dest_file)
            copied_files.append(file)
    print('Models copied: {}'.format(copied_files))
else:
    print('Directory not found: {}'.format(models_source_path))
          "
          
          echo "Verifying copied models:"
          ls -la models/

      - name: Download additional models if needed
        run: |
          echo "Verifying and downloading additional models if needed..."
          
          # Verify shape_predictor_68_face_landmarks.dat
          if [ ! -f "models/shape_predictor_68_face_landmarks.dat" ]; then
              echo "Downloading shape_predictor_68_face_landmarks.dat..."
              wget -O models/shape_predictor_68_face_landmarks.dat.bz2 https://github.com/davisking/dlib-models/raw/master/shape_predictor_68_face_landmarks.dat.bz2
              cd models && bunzip2 shape_predictor_68_face_landmarks.dat.bz2 && cd ..
              echo "shape_predictor_68_face_landmarks.dat downloaded"
          else
              echo "shape_predictor_68_face_landmarks.dat already exists"
          fi
          
          # Verify dlib_face_recognition_resnet_model_v1.dat
          if [ ! -f "models/dlib_face_recognition_resnet_model_v1.dat" ]; then
              echo "Downloading dlib_face_recognition_resnet_model_v1.dat..."
              wget -O models/dlib_face_recognition_resnet_model_v1.dat.bz2 https://github.com/davisking/dlib-models/raw/master/dlib_face_recognition_resnet_model_v1.dat.bz2
              cd models && bunzip2 dlib_face_recognition_resnet_model_v1.dat.bz2 && cd ..
              echo "dlib_face_recognition_resnet_model_v1.dat downloaded"
          else
              echo "dlib_face_recognition_resnet_model_v1.dat already exists"
          fi
          
          echo "Final models list:"
          ls -la models/

      - name: Create PyInstaller spec file
        run: |
          cat > main.spec << 'EOF'
          # -*- mode: python ; coding: utf-8 -*-
          
          block_cipher = None
          
          a = Analysis(
              ['main.py'],
              pathex=[],
              binaries=[],
              datas=[
                  ('models', 'models'),
                  ('static', 'static'),
              ],
              hiddenimports=[
                  'face_recognition_models',
                  'dlib',
                  'cv2',
                  'numpy',
                  'torch',
                  'torchvision',
                  'facenet_pytorch',
                  'insightface',
                  'scipy',
                  'sklearn',
                  'PIL',
                  'cryptography',
                  'hkdf',
                  'aiosqlite',
                  'chromadb',
                  'httpx',
                  'fastapi',
                  'uvicorn',
                  'torch.nn',
                  'torch.optim',
                  'torch.utils.data',
                  'torch.backends.cudnn',
                  'torch.autograd',
                  'torch.serialization',
                  'onnxruntime',
                  'onnx',
                  'yaml',
                  'tqdm',
                  'requests',
                  'PIL._imagingtk',
                  'PIL._tkinter_finder',
                  'pkg_resources.py2_warn',
                  'matplotlib.backends.backend_tkagg',
              ],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=block_cipher,
              noarchive=False,
          )
          
          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)
          
          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.zipfiles,
              a.datas,
              [],
              name='main',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              upx_exclude=[],
              runtime_tmpdir=None,
              console=True,
              disable_windowed_traceback=False,
              argv_emulation=False,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
          )
          EOF

      - name: Verify spec file
        run: |
          echo "Verifying spec file:"
          grep -A 5 "datas" main.spec

      - name: Build executable with PyInstaller
        run: |
          echo "Building executable with PyInstaller..."
          pyinstaller main.spec

      - name: Verify executable and included files
        run: |
          echo "Verifying created executable:"
          if [ -f "dist/main" ]; then
              echo "main executable found"
              ls -la dist/main
              
              echo "Verifying dist directory structure:"
              find dist -type f
          else
              echo "main executable not found"
              exit 1
          fi

      - name: Create final package directory
        run: |
          echo "Creating final package..."
          mkdir -p fotoshow-ubuntu
          
          # Copy executable
          cp dist/main fotoshow-ubuntu/
          
          # Copy static files if they exist
          if [ -d "static" ]; then
              echo "Copying static files..."
              cp -r static/* fotoshow-ubuntu/static/
          fi
          
          # Copy models
          echo "Copying models..."
          cp -r models/* fotoshow-ubuntu/models/
          
          # Create execution script
          cat > fotoshow-ubuntu/run.sh << 'EOF'
          #!/bin/bash
          
          echo "======================================="
          echo "       FOTOSHOW"
          echo "   Facial Recognition System"
          echo "======================================="
          echo ""
          echo "Starting application..."
          echo ""
          
          # Get the directory where this script is located
          DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
          
          # Change to that directory
          cd "$DIR"
          
          # Set library path
          export LD_LIBRARY_PATH="$DIR:$LD_LIBRARY_PATH"
          
          # Run the executable
          ./main
          
          # Check if execution was successful
          if [ $? -ne 0 ]; then
              echo ""
              echo "Error executing the application."
              read -p "Press Enter to continue..."
              exit 1
          fi
          EOF
          
          # Make the script executable
          chmod +x fotoshow-ubuntu/run.sh
          
          # Create README
          cat > fotoshow-ubuntu/README.md << 'EOF'
          # FOTOSHOW - Ubuntu Package
          
          ## Execution Instructions
          
          ### Option 1: Automatic Execution (Recommended)
          1. Open a terminal
          2. Navigate to the directory where you extracted the package
          3. Run: ./run.sh
          
          ### Option 2: Manual Execution
          1. Open a terminal
          2. Navigate to the directory where you extracted the package
          3. Run: ./main
          
          ## Included Files
          - 'main': Main application executable
          - 'models/': Facial recognition models (dlib)
          - 'static/': Web interface static files
          - 'run.sh': Automatic execution script
          
          ## Important Notes
          - Make sure all files remain in their respective folders
          - Do not move or delete the 'models/' folder
          - The application needs internet access for some features
          - Ensure the scripts have execution permissions (chmod +x)
          
          ## System Requirements
          - Ubuntu 18.04 or higher
          - 4GB RAM or more (8GB recommended)
          - Disk space: 500MB free
          - Web camera (optional, for capture function)
          EOF
          
          echo "Final package content:"
          find fotoshow-ubuntu -type f

      - name: Create tar.gz package
        run: |
          echo "Creating tar.gz package..."
          tar -czf fotoshow-ubuntu.tar.gz -C fotoshow-ubuntu .
          echo "tar.gz package created: fotoshow-ubuntu.tar.gz"

      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-executable
          path: dist/main

      - name: Upload complete package artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-package
          path: fotoshow-ubuntu.tar.gz

      - name: Upload package directory artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-package-dir
          path: fotoshow-ubuntu/
