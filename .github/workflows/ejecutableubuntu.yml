- name: Create simplified PyInstaller spec file
  run: |
    cat > main.spec << 'EOF'
    a = Analysis(['main.py'], pathex=[], binaries=[], datas=[('models', 'models'), ('static', 'static')], hiddenimports=['face_recognition_models', 'dlib', 'cv2', 'numpy', 'torch', 'torchvision', 'facenet_pytorch', 'insightface', 'scipy', 'sklearn', 'PIL', 'cryptography', 'hkdf', 'aiosqlite', 'chromadb', 'httpx', 'fastapi', 'uvicorn'])
    exe = EXE(a.scripts, a.binaries, a.zipfiles, a.datas, [], name='main', debug=False, console=True)
    EOF

- name: Build executable with one-file mode disabled
  run: pyinstaller --onedir --noconfirm main.spec

- name: Create package from directory
  run: |
    mkdir -p fotoshow-ubuntu
    cp -r dist/main/* fotoshow-ubuntu/
    if [ -d "static" ]; then cp -r static/* fotoshow-ubuntu/static/; fi
    cp -r models/* fotoshow-ubuntu/models/
    echo '#!/bin/bash' > fotoshow-ubuntu/run.sh
    echo 'DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"' >> fotoshow-ubuntu/run.sh
    echo 'cd "$DIR"' >> fotoshow-ubuntu/run.sh
    echo 'export LD_LIBRARY_PATH="$DIR:$LD_LIBRARY_PATH"' >> fotoshow-ubuntu/run.sh
    echo './main' >> fotoshow-ubuntu/run.sh
    chmod +x fotoshow-ubuntu/run.sh
    tar -czf fotoshow-ubuntu.tar.gz -C fotoshow-ubuntu .
