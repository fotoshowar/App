name: Build Ubuntu Executable

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: sudo apt-get update
      - run: sudo apt-get install -y build-essential cmake libopenblas-dev liblapack-dev libx11-dev libgtk-3-dev python3-dev python3-pip pkg-config libavcodec-dev libavformat-dev libswscale-dev libtbb-dev libjpeg-dev libpng-dev libtiff-dev libdc1394-dev libv4l-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libglib2.0-dev libatlas-base-dev
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements.txt
      - run: pip install pyinstaller==5.13.2
      - run: mkdir -p models
      - run: pip install face_recognition_models
      - name: Create copy models script
        run: echo 'import face_recognition_models; import os; import shutil; models_source_path = os.path.join(os.path.dirname(face_recognition_models.__file__), "models"); [shutil.copy2(os.path.join(models_source_path, f), os.path.join("models", f)) for f in os.listdir(models_source_path) if f.endswith(".dat")]' > copy_models.py
      - run: python3 copy_models.py
      - run: if [ ! -f "models/shape_predictor_68_face_landmarks.dat" ]; then wget -O models/shape_predictor_68_face_landmarks.dat.bz2 https://github.com/davisking/dlib-models/raw/master/shape_predictor_68_face_landmarks.dat.bz2 && cd models && bunzip2 shape_predictor_68_face_landmarks.dat.bz2 && cd ..; fi
      - run: if [ ! -f "models/dlib_face_recognition_resnet_model_v1.dat" ]; then wget -O models/dlib_face_recognition_resnet_model_v1.dat.bz2 https://github.com/davisking/dlib-models/raw/master/dlib_face_recognition_resnet_model_v1.dat.bz2 && cd models && bunzip2 dlib_face_recognition_resnet_model_v1.dat.bz2 && cd ..; fi
      - name: Create spec file
        run: echo 'a = Analysis(["main.py"], pathex=[], binaries=[], datas=[("models", "models"), ("static", "static")], hiddenimports=["face_recognition_models", "dlib", "cv2", "numpy", "torch", "torchvision", "facenet_pytorch", "insightface", "scipy", "sklearn", "PIL", "cryptography", "hkdf", "aiosqlite", "chromadb", "httpx", "fastapi", "uvicorn"])' > main.spec && echo 'exe = EXE(a.scripts, a.binaries, a.zipfiles, a.datas, [], name="main", debug=False, console=True)' >> main.spec
      - run: pyinstaller main.spec
      - run: mkdir -p fotoshow-ubuntu
      - run: cp dist/main fotoshow-ubuntu/
      - run: if [ -d "static" ]; then cp -r static/* fotoshow-ubuntu/static/; fi
      - run: cp -r models/* fotoshow-ubuntu/models/
      - name: Create run script
        run: echo '#!/bin/bash' > fotoshow-ubuntu/run.sh && echo 'DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"' >> fotoshow-ubuntu/run.sh && echo 'cd "$DIR"' >> fotoshow-ubuntu/run.sh && echo 'export LD_LIBRARY_PATH="$DIR:$LD_LIBRARY_PATH"' >> fotoshow-ubuntu/run.sh && echo './main' >> fotoshow-ubuntu/run.sh
      - run: chmod +x fotoshow-ubuntu/run.sh
      - run: tar -czf fotoshow-ubuntu.tar.gz -C fotoshow-ubuntu .
      - uses: actions/upload-artifact@v4
        with:
          name: ubuntu-package
          path: fotoshow-ubuntu.tar.gz
